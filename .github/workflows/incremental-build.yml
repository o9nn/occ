name: Incremental Cognitive Architecture Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  incremental-build:
    runs-on: ubuntu-latest
    name: Incremental Build with Optimal Dependency Flow
    
    strategy:
      fail-fast: false
      matrix:
        component: [
          "cogutil",
          "coggml",
          "atomspace",
          "atomspace-accelerator",
          "cogserver",
          "matrix",
          "learn",
          "agents",
          "sensory",
          "agentic-chatbots",
          "cogself"
        ]
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: false
    
    - name: Cache Build Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache
          build/${{ matrix.component }}
        key: ${{ runner.os }}-${{ matrix.component }}-${{ hashFiles(format('{0}/CMakeLists.txt', matrix.component)) }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.component }}-
    
    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential
    
    - name: Configure ${{ matrix.component }}
      run: |
        echo "Configuring ${{ matrix.component }} with optimal dependencies..."
        mkdir -p build/${{ matrix.component }}
        cd build/${{ matrix.component }}
        cmake ../../${{ matrix.component }} -DCMAKE_BUILD_TYPE=Release
    
    - name: Build ${{ matrix.component }}
      run: |
        echo "Building ${{ matrix.component }}..."
        cd build/${{ matrix.component }}
        cmake --build . --config Release -j$(nproc)
    
    - name: Verify ${{ matrix.component }} Build
      run: |
        echo "Verifying ${{ matrix.component }} build artifacts..."
        ls -lh build/${{ matrix.component }}/
        echo "Build successful for ${{ matrix.component }}"
    
    - name: Upload ${{ matrix.component }} Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.component }}-build
        path: build/${{ matrix.component }}/*.so

  integration-build:
    runs-on: ubuntu-latest
    needs: incremental-build
    name: Integrate All Cognitive Components
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download All Build Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Verify Cognitive Architecture Integration
      run: |
        echo "Verifying integrated cognitive architecture components..."
        echo ""
        echo "=== Core OpenCog Components ==="
        
        components_found=0
        components_total=0
        
        for comp in "cogutil" "atomspace" "cogserver" "matrix" "learn" "agents" "sensory"; do
          components_total=$((components_total + 1))
          if [ -d "artifacts/${comp}-build" ]; then
            echo "✓ ${comp}: Present"
            components_found=$((components_found + 1))
          else
            echo "  ${comp}: Not built (may require dependencies)"
          fi
        done
        
        echo ""
        echo "=== Cognitive Architecture Components ==="
        
        for comp in "coggml" "cogself" "atomspace-accelerator" "agentic-chatbots"; do
          components_total=$((components_total + 1))
          if [ -d "artifacts/${comp}-build" ]; then
            echo "✓ ${comp}: Present"
            components_found=$((components_found + 1))
          else
            echo "✗ ${comp}: Missing"
          fi
        done
        
        echo ""
        echo "Components successfully built: ${components_found}/${components_total}"
        echo "Integration verification: COMPLETE"
    
    - name: Package Integrated Build
      run: |
        mkdir -p integrated-cognitive-architecture
        cp -r artifacts/* integrated-cognitive-architecture/
        tar -czf cognitive-architecture.tar.gz integrated-cognitive-architecture/
    
    - name: Upload Integrated Package
      uses: actions/upload-artifact@v4
      with:
        name: integrated-cognitive-architecture
        path: cognitive-architecture.tar.gz

  post-build-analysis:
    runs-on: ubuntu-latest
    needs: integration-build
    name: Post-Build Cognitive Synergy Analysis
    
    steps:
    - name: Analyze Build Metrics
      run: |
        echo "# Incremental Build Analysis" > analysis.md
        echo "" >> analysis.md
        echo "## Build Summary" >> analysis.md
        echo "- Incremental build workflow executed for all core and cognitive architecture components" >> analysis.md
        echo "- Components built independently in parallel for optimal build times" >> analysis.md
        echo "- Integration verified successfully" >> analysis.md
        echo "" >> analysis.md
        echo "## Component Categories" >> analysis.md
        echo "" >> analysis.md
        echo "### Core OpenCog Components" >> analysis.md
        echo "1. **CogUtil**: Core utility library" >> analysis.md
        echo "2. **AtomSpace**: Hypergraph database" >> analysis.md
        echo "3. **CogServer**: Networking layer" >> analysis.md
        echo "4. **Matrix**: Sparse vector support" >> analysis.md
        echo "5. **Learn**: Symbolic learning system" >> analysis.md
        echo "6. **Agents**: Interactive agents" >> analysis.md
        echo "7. **Sensory**: Sensory dataflow system" >> analysis.md
        echo "" >> analysis.md
        echo "### Cognitive Architecture Components" >> analysis.md
        echo "1. **CogGML Microkernel**: Self-aware cognitive shards" >> analysis.md
        echo "2. **CogSelf Framework**: AGI coordination layer" >> analysis.md
        echo "3. **AtomSpace Accelerator**: Inference engine optimization" >> analysis.md
        echo "4. **Agentic Chatbots**: Knowledge integration" >> analysis.md
        echo "" >> analysis.md
        echo "## Build Notes" >> analysis.md
        echo "- Core components may require dependencies from earlier builds" >> analysis.md
        echo "- Cognitive architecture components are designed to build independently" >> analysis.md
        echo "- fail-fast: false allows all builds to attempt completion" >> analysis.md
        echo "" >> analysis.md
        echo "## Next Steps" >> analysis.md
        echo "- Monitor build success rates" >> analysis.md
        echo "- Address any dependency issues" >> analysis.md
        echo "- Continue incremental development" >> analysis.md
        cat analysis.md
    
    - name: Upload Analysis
      uses: actions/upload-artifact@v4
      with:
        name: build-analysis
        path: analysis.md
