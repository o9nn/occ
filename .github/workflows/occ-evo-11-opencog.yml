name: OCC Evo-11 - OpenCog Build

# Comprehensive OpenCog Collection build workflow
# Based on occ-build.yml structure with all components from ocall.yml
# Implements proper serial-parallel dependency chains for optimal build time
# Generated: December 12, 2025

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  MAKEFLAGS: -j2

jobs:

  # ============================================================================
  # LAYER 11: Applications
  # ============================================================================
  
  build-opencog:
    runs-on: ubuntu-latest
    name: "L11: Build OpenCog (Main Application)"
    needs: [build-pln, build-learn, build-attention]
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake build-essential \
          libboost-dev libboost-system-dev guile-3.0-dev
    
    - name: Rebuild Dependencies
      run: |
        for dir in cogutil atomspace atomspace-storage cogserver unify ure spacetime pln learn attention; do
          if [ -d "$dir" ]; then
            mkdir -p $dir/build && cd $dir/build
            cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
            make ${{ env.MAKEFLAGS }} && sudo make install && sudo ldconfig
            cd ../..
          fi
        done
    
    - name: Check Component Existence
      run: |
        if [ ! -d "opencog" ]; then
          echo "OpenCog directory not found, skipping"
          exit 0
        fi
    
    - name: Configure OpenCog
      if: hashFiles('opencog/CMakeLists.txt') != ''
      run: |
        mkdir -p opencog/build
        cd opencog/build
        cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
    
    - name: Build OpenCog
      if: hashFiles('opencog/CMakeLists.txt') != ''
      run: |
        cd opencog/build
        make ${{ env.MAKEFLAGS }}
    
    - name: Install OpenCog
      if: hashFiles('opencog/CMakeLists.txt') != ''
      run: |
        cd opencog/build
        sudo make install
        sudo ldconfig

