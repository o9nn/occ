name: Build Chocolatey Package

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to package'
        required: true
        default: '1.0.0'

env:
  PACKAGE_NAME: opencog

jobs:
  build-windows:
    runs-on: windows-latest
    name: Build Windows Binaries
    # This job is currently disabled - it should use the artifacts from wincog.yml or occ-win-build.yml
    # Re-enable after Windows builds are stable
    if: false
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
    
    - name: Set Version
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "release") {
          $version = "${{ github.event.release.tag_name }}".TrimStart('v')
        } else {
          $version = "${{ github.event.inputs.version }}"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Package version: $version"
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '544a4c5c297e60e4ac4a5a1810df66748d908869'
    
    - name: Install Build Dependencies
      shell: pwsh
      run: |
        # Install required vcpkg packages
        vcpkg install boost-system boost-filesystem boost-program-options boost-thread boost-date-time
        vcpkg integrate install
    
    - name: Build OpenCog Collection
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        
        # Run the enhanced build script
        .\build-windows.ps1 `
          -VcpkgRoot "$env:VCPKG_ROOT" `
          -InstallPrefix "C:\OpenCog" `
          -BuildType Release `
          -SkipTests `
          -BuildAtomspaceStorage `
          -ParallelJobs 2
    
    - name: Verify Build Output
      shell: pwsh
      run: |
        if (-not (Test-Path "dist\opencog-*.zip")) {
          Write-Error "Build did not produce distribution package!"
          exit 1
        }
        
        Write-Host "Build artifacts:"
        Get-ChildItem dist\* | ForEach-Object { Write-Host "  $_" }
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-binaries
        path: |
          dist/*.zip
          dist/*.sha256
        retention-days: 30

  build-chocolatey:
    runs-on: windows-latest
    name: Build Chocolatey Package
    needs: build-windows
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set Version
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "release") {
          $version = "${{ github.event.release.tag_name }}".TrimStart('v')
        } else {
          $version = "${{ github.event.inputs.version }}"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Package version: $version"
    
    - name: Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-binaries
        path: dist
    
    - name: Install Chocolatey
      shell: pwsh
      run: |
        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }
        choco --version
    
    - name: Prepare Chocolatey Package
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        
        # Extract ZIP to tools directory for packaging
        $zipFile = Get-ChildItem dist\opencog-*.zip | Select-Object -First 1
        $toolsDir = "packaging\chocolatey\tools\opencog"
        
        if (Test-Path $toolsDir) {
          Remove-Item -Recurse -Force $toolsDir
        }
        New-Item -ItemType Directory -Path $toolsDir -Force | Out-Null
        
        Write-Host "Extracting $zipFile to $toolsDir..."
        Expand-Archive -Path $zipFile -DestinationPath $toolsDir -Force
        
        # Get checksum
        $checksumFile = Get-ChildItem dist\*.sha256 | Select-Object -First 1
        $checksum = (Get-Content $checksumFile).Split()[0]
        
        Write-Host "Checksum: $checksum"
        
        # Update nuspec version
        $nuspecPath = "packaging\chocolatey\opencog.nuspec"
        $content = Get-Content $nuspecPath -Raw
        $content = $content -replace '<version>0\.0\.0</version>', "<version>$version</version>"
        Set-Content $nuspecPath $content
        
        Write-Host "Updated nuspec with version $version"
        
        # Update install script for local installation
        $installScript = "packaging\chocolatey\tools\chocolateyinstall.ps1"
        $installContent = @"
`$ErrorActionPreference = 'Stop'

`$packageName = 'opencog'
`$toolsDir = "`$(Split-Path -parent `$MyInvocation.MyCommand.Definition)"
`$installPath = Join-Path `$toolsDir 'opencog'

Write-Host "Installing OpenCog from local package..."
Write-Host "Installation directory: `$installPath"

# Add to PATH
Install-ChocolateyPath -PathToInstall "`$installPath\bin" -PathType 'Machine'

Write-Host "OpenCog has been installed successfully!"
Write-Host "Installation directory: `$installPath"
Write-Host ""
Write-Host "To get started:"
Write-Host "  1. Open a new command prompt or PowerShell window"
Write-Host "  2. Run 'guile' to start the Scheme interpreter"
Write-Host "  3. Load OpenCog: (use-modules (opencog))"
Write-Host ""
Write-Host "For more information, visit: https://wiki.opencog.org/"
"@
        Set-Content $installScript $installContent
        
        Write-Host "Updated install script for local installation"
    
    - name: Build Chocolatey Package
      shell: pwsh
      run: |
        cd packaging\chocolatey
        choco pack opencog.nuspec
        
        if (Test-Path "*.nupkg") {
          Write-Host "Chocolatey package created successfully:"
          Get-ChildItem *.nupkg | ForEach-Object { Write-Host "  $_" }
        } else {
          Write-Error "Failed to create Chocolatey package"
          exit 1
        }
    
    - name: Test Package Installation
      shell: pwsh
      run: |
        cd packaging\chocolatey
        $package = Get-ChildItem *.nupkg | Select-Object -First 1
        
        Write-Host "Testing package installation: $package"
        # Test install in local mode
        choco install $package.Name --source="'.'" --force --debug --verbose
        
        # Verify installation
        if (Get-Command opencog -ErrorAction SilentlyContinue) {
          Write-Host "âœ“ OpenCog command found in PATH"
        } else {
          Write-Warning "OpenCog command not found in PATH (may require new shell)"
        }
    
    - name: Upload Chocolatey Package
      uses: actions/upload-artifact@v4
      with:
        name: chocolatey-package
        path: packaging/chocolatey/*.nupkg
        retention-days: 30
    
    - name: Publish to Chocolatey (Optional)
      if: github.event_name == 'release' && github.event.release.prerelease == false
      shell: pwsh
      env:
        CHOCO_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
      run: |
        if ($env:CHOCO_API_KEY) {
          cd packaging\chocolatey
          $package = Get-ChildItem *.nupkg | Select-Object -First 1
          
          Write-Host "Publishing package to Chocolatey: $package"
          choco push $package.Name --source https://push.chocolatey.org/ --api-key $env:CHOCO_API_KEY
          
          Write-Host "Package published successfully!"
        } else {
          Write-Host "CHOCOLATEY_API_KEY not set, skipping publish"
        }
    
    - name: Upload to GitHub Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          packaging/chocolatey/*.nupkg
          dist/*.zip
          dist/*.sha256
