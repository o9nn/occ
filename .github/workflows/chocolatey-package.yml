name: Build Chocolatey Package

# Chocolatey packaging workflow for OpenCog Collection
# Depends on successful Windows builds from occ-win-build-complete.yml
# Creates installable Chocolatey package for Windows

on:
  workflow_run:
    workflows: ["OCC Windows Build - Complete Stack", "OCC Windows Build (Enhanced with Retry)"]
    types:
      - completed
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Package version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      force_build:
        description: 'Force build even if workflow failed'
        required: false
        type: boolean
        default: false

env:
  PACKAGE_NAME: opencog-occ
  PACKAGE_MAINTAINER: "OpenCog Community"

jobs:
  build-chocolatey:
    runs-on: windows-latest
    name: Build Chocolatey Package
    if: |
      github.event.workflow_run.conclusion == 'success' ||
      github.event_name == 'release' ||
      github.event_name == 'workflow_dispatch' ||
      github.event.inputs.force_build == 'true'
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Determine Package Version
      id: version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "release") {
          $version = "${{ github.event.release.tag_name }}".TrimStart('v')
        } elseif ("${{ github.event.inputs.version }}") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          # Generate version from date and commit
          $date = Get-Date -Format "yyyy.MM.dd"
          $commit = "${{ github.sha }}".Substring(0, 7)
          $version = "$date-$commit"
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        Write-Host "üì¶ Package version: $version" -ForegroundColor Cyan
    
    - name: Download Complete Build Artifacts
      uses: actions/download-artifact@v4
      with:
        path: build-artifacts
      continue-on-error: true
    
    - name: Consolidate Build Artifacts
      shell: pwsh
      run: |
        Write-Host "=== Consolidating Build Artifacts ===" -ForegroundColor Cyan
        
        # Create consolidated directory
        New-Item -ItemType Directory -Force -Path "consolidated" | Out-Null
        
        # Copy all artifacts to consolidated directory
        if (Test-Path "build-artifacts") {
          Get-ChildItem -Path "build-artifacts" -Recurse -File | ForEach-Object {
            $dest = Join-Path "consolidated" $_.Name
            Copy-Item -Path $_.FullName -Destination $dest -Force
            Write-Host "  Copied: $($_.Name)" -ForegroundColor Green
          }
        }
        
        Write-Host "‚úì Consolidation complete" -ForegroundColor Green
    
    - name: Verify Artifacts
      id: verify
      shell: pwsh
      run: |
        Write-Host "=== Verifying Build Artifacts ===" -ForegroundColor Cyan
        
        if (Test-Path "consolidated") {
          $files = Get-ChildItem -Path consolidated -Recurse -File
          Write-Host "‚úì Found $($files.Count) files in artifacts" -ForegroundColor Green
          echo "HAS_ARTIFACTS=true" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "‚ö† No artifacts found, will create minimal package" -ForegroundColor Yellow
          echo "HAS_ARTIFACTS=false" >> $env:GITHUB_OUTPUT
        }
    
    - name: Install Chocolatey
      shell: pwsh
      run: |
        Write-Host "=== Installing Chocolatey ===" -ForegroundColor Cyan
        if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        }
        choco --version
        Write-Host "‚úì Chocolatey installed" -ForegroundColor Green
    
    - name: Create Package Directory Structure
      shell: pwsh
      run: |
        Write-Host "=== Creating Package Structure ===" -ForegroundColor Cyan
        
        # Create chocolatey package directory
        New-Item -ItemType Directory -Force -Path "choco-package/tools" | Out-Null
        New-Item -ItemType Directory -Force -Path "choco-package/legal" | Out-Null
        
        # Copy build artifacts if available
        if (Test-Path "consolidated") {
          Copy-Item -Path "consolidated/*" -Destination "choco-package/tools" -Recurse -Force
          Write-Host "‚úì Copied build artifacts" -ForegroundColor Green
        }
        
        Write-Host "‚úì Package structure created" -ForegroundColor Green
    
    - name: Create Chocolatey Nuspec
      shell: pwsh
      run: |
        Write-Host "=== Creating Nuspec File ===" -ForegroundColor Cyan
        
        $nuspec = @"
<?xml version="1.0" encoding="utf-8"?>
<package xmlns="http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd">
  <metadata>
    <id>$env:PACKAGE_NAME</id>
    <version>${{ steps.version.outputs.VERSION }}</version>
    <title>OpenCog Collection (OCC)</title>
    <authors>$env:PACKAGE_MAINTAINER</authors>
    <owners>$env:PACKAGE_MAINTAINER</owners>
    <licenseUrl>https://github.com/o9nn/occ/blob/main/LICENSE</licenseUrl>
    <projectUrl>https://github.com/o9nn/occ</projectUrl>
    <requireLicenseAcceptance>false</requireLicenseAcceptance>
    <description>
OpenCog Collection (OCC) - A comprehensive monorepo of OpenCog cognitive architecture components.

Includes:
- CogUtil: Foundation utilities and data structures
- AtomSpace: Hypergraph knowledge representation system
- Moses: Meta-optimizing semantic evolutionary search
- CogServer: Network server for AtomSpace
- URE: Unified Rule Engine
- And many more cognitive AI components

This package provides pre-built Windows binaries for the OpenCog framework.
    </description>
    <summary>OpenCog cognitive architecture framework for Windows</summary>
    <tags>opencog ai agi cognitive-architecture atomspace moses machine-learning</tags>
    <copyright>Copyright ¬© 2025 OpenCog Community</copyright>
    <dependencies>
      <dependency id="vcredist140" version="14.0" />
    </dependencies>
  </metadata>
  <files>
    <file src="tools\**" target="tools" />
    <file src="legal\**" target="legal" />
  </files>
</package>
"@
        
        Set-Content -Path "choco-package/$env:PACKAGE_NAME.nuspec" -Value $nuspec
        Write-Host "‚úì Nuspec file created" -ForegroundColor Green
    
    - name: Create Installation Script
      shell: pwsh
      run: |
        Write-Host "=== Creating Installation Script ===" -ForegroundColor Cyan
        
        $installScript = @'
$ErrorActionPreference = 'Stop'
$packageName = $env:ChocolateyPackageName
$toolsDir = "$(Split-Path -parent $MyInvocation.MyCommand.Definition)"
$installDir = Join-Path $env:ProgramFiles "OpenCog\OCC"

Write-Host "Installing $packageName to $installDir" -ForegroundColor Cyan

# Create installation directory
New-Item -ItemType Directory -Force -Path $installDir | Out-Null

# Copy all files from tools directory
if (Test-Path "$toolsDir\bin") {
    Copy-Item -Path "$toolsDir\*" -Destination $installDir -Recurse -Force
    Write-Host "Installed OpenCog binaries to $installDir" -ForegroundColor Green
    
    # Add to PATH
    Install-ChocolateyPath -PathToInstall "$installDir\bin" -PathType 'Machine'
    
    # Set environment variable
    Install-ChocolateyEnvironmentVariable -VariableName 'OPENCOG_HOME' -VariableValue $installDir -VariableType 'Machine'
    
    Write-Host "OpenCog Collection installed successfully!" -ForegroundColor Green
    Write-Host "OPENCOG_HOME set to: $installDir" -ForegroundColor Cyan
    Write-Host "Added to PATH: $installDir\bin" -ForegroundColor Cyan
} else {
    Write-Host "No binaries found in package. This is a minimal installation." -ForegroundColor Yellow
}
'@
        
        Set-Content -Path "choco-package/tools/chocolateyinstall.ps1" -Value $installScript
        Write-Host "‚úì Installation script created" -ForegroundColor Green
    
    - name: Create Uninstallation Script
      shell: pwsh
      run: |
        Write-Host "=== Creating Uninstallation Script ===" -ForegroundColor Cyan
        
        $uninstallScript = @'
$ErrorActionPreference = 'Stop'
$packageName = $env:ChocolateyPackageName
$installDir = Join-Path $env:ProgramFiles "OpenCog\OCC"

Write-Host "Uninstalling $packageName" -ForegroundColor Cyan

# Remove from PATH
Uninstall-ChocolateyPath -PathToUninstall "$installDir\bin" -PathType 'Machine'

# Remove environment variable
Uninstall-ChocolateyEnvironmentVariable -VariableName 'OPENCOG_HOME' -VariableType 'Machine'

# Remove installation directory
if (Test-Path $installDir) {
    Remove-Item -Path $installDir -Recurse -Force
    Write-Host "Removed installation directory: $installDir" -ForegroundColor Green
}

Write-Host "OpenCog Collection uninstalled successfully!" -ForegroundColor Green
'@
        
        Set-Content -Path "choco-package/tools/chocolateyuninstall.ps1" -Value $uninstallScript
        Write-Host "‚úì Uninstallation script created" -ForegroundColor Green
    
    - name: Create License File
      shell: pwsh
      run: |
        Write-Host "=== Creating License File ===" -ForegroundColor Cyan
        
        if (Test-Path "LICENSE") {
          Copy-Item -Path "LICENSE" -Destination "choco-package/legal/LICENSE.txt"
        } else {
          $license = @"
OpenCog Collection (OCC)
Copyright ¬© 2025 OpenCog Community

Licensed under the GNU Affero General Public License v3.0
See: https://github.com/o9nn/occ/blob/main/LICENSE
"@
          Set-Content -Path "choco-package/legal/LICENSE.txt" -Value $license
        }
        
        Write-Host "‚úì License file created" -ForegroundColor Green
    
    - name: Build Chocolatey Package
      shell: pwsh
      run: |
        Write-Host "=== Building Chocolatey Package ===" -ForegroundColor Cyan
        Set-Location choco-package
        choco pack
        Write-Host "‚úì Package built successfully" -ForegroundColor Green
    
    - name: Test Package Installation
      shell: pwsh
      run: |
        Write-Host "=== Testing Package Installation ===" -ForegroundColor Cyan
        Set-Location choco-package
        $package = Get-ChildItem -Filter "*.nupkg" | Select-Object -First 1
        
        if ($package) {
          Write-Host "Testing installation of: $($package.Name)" -ForegroundColor Yellow
          choco install $package.Name -s . -y --force
          
          Write-Host "‚úì Package installed successfully" -ForegroundColor Green
          
          # Uninstall test package
          choco uninstall $env:PACKAGE_NAME -y
          Write-Host "‚úì Package uninstalled successfully" -ForegroundColor Green
        } else {
          Write-Host "‚ö† No package file found to test" -ForegroundColor Yellow
        }
      continue-on-error: true
    
    - name: Upload Chocolatey Package
      uses: actions/upload-artifact@v4
      with:
        name: chocolatey-package-${{ steps.version.outputs.VERSION }}
        path: choco-package/*.nupkg
        retention-days: 30
    
    - name: Package Summary
      shell: pwsh
      run: |
        Write-Host "=== Chocolatey Package Summary ===" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "Package Name: $env:PACKAGE_NAME" -ForegroundColor Yellow
        Write-Host "Version: ${{ steps.version.outputs.VERSION }}" -ForegroundColor Yellow
        Write-Host "Has Artifacts: ${{ steps.verify.outputs.HAS_ARTIFACTS }}" -ForegroundColor Yellow
        Write-Host ""
        
        $package = Get-ChildItem -Path choco-package -Filter "*.nupkg" | Select-Object -First 1
        if ($package) {
          Write-Host "‚úÖ Package created: $($package.Name)" -ForegroundColor Green
          Write-Host "Size: $([math]::Round($package.Length / 1MB, 2)) MB" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "To install locally:" -ForegroundColor Cyan
          Write-Host "  choco install $env:PACKAGE_NAME -s path/to/package -y" -ForegroundColor White
          Write-Host ""
          Write-Host "To publish to Chocolatey Community:" -ForegroundColor Cyan
          Write-Host "  choco push $($package.Name) --source https://push.chocolatey.org/" -ForegroundColor White
        } else {
          Write-Host "‚ùå No package file created" -ForegroundColor Red
          exit 1
        }
