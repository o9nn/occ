name: VCpkg Prebuild Cache

# Standalone workflow that prebuilds vcpkg dependencies in stages
# Each stage caches independently - no more losing 2+ hours on late failures
# Run weekly, on vcpkg.json changes, or manually

on:
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all packages (ignore cache)'
        required: false
        default: 'false'
        type: boolean
      tier:
        description: 'Which tier to build (all, tier1, tier2, tier3)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - tier1
          - tier2
          - tier3
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
  push:
    paths:
      - 'vcpkg.json'
      - 'vcpkg-configuration.json'
      - '.github/workflows/vcpkg-prebuild.yml'

concurrency:
  group: vcpkg-prebuild-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel - we want to complete

env:
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg_binary_cache
  VCPKG_INSTALLED_DIR: ${{ github.workspace }}/vcpkg_installed

jobs:
  # =============================================================================
  # TIER 1: Quick packages (~5-10 min)
  # Boost headers, cmake tools, header-only libs
  # =============================================================================
  tier1-quick:
    if: ${{ github.event.inputs.tier == 'all' || github.event.inputs.tier == 'tier1' || github.event.inputs.tier == '' }}
    runs-on: windows-latest
    name: "Tier 1: Quick Packages"
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Cache Key
        id: cache-key
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Path vcpkg.json -Algorithm SHA256).Hash.Substring(0, 12)
          $key = "vcpkg-tier1-x64-windows-$hash"
          echo "key=$key" >> $env:GITHUB_OUTPUT
          Write-Host "Cache key: $key" -ForegroundColor Cyan

      - name: Setup Cache Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:VCPKG_INSTALLED_DIR" | Out-Null

      # Export GitHub Actions cache environment for vcpkg
      - name: Export GitHub Actions Cache Variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Restore Tier 1 Cache
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
            ${{ env.VCPKG_INSTALLED_DIR }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            vcpkg-tier1-x64-windows-

      - name: Setup vcpkg
        id: vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '11bbc873e00e9e58d4e9dffb30b7a5493a030e0b'

      - name: Verify vcpkg Setup
        shell: pwsh
        run: |
          # Determine vcpkg root - action stores it in VCPKG_ROOT or github workspace
          $vcpkgRoot = $env:VCPKG_ROOT
          if (-not $vcpkgRoot) {
            $vcpkgRoot = "${{ github.workspace }}/vcpkg"
          }

          Write-Host "VCPKG_ROOT: $vcpkgRoot" -ForegroundColor Cyan

          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          if (Test-Path $vcpkgExe) {
            Write-Host "vcpkg.exe found at: $vcpkgExe" -ForegroundColor Green
            & $vcpkgExe --version
          } else {
            Write-Host "ERROR: vcpkg.exe not found at $vcpkgExe" -ForegroundColor Red
            Write-Host "Searching for vcpkg.exe..." -ForegroundColor Yellow
            Get-ChildItem -Path "${{ github.workspace }}" -Recurse -Filter "vcpkg.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "Found: $($_.FullName)" }
            exit 1
          }

          # Export for subsequent steps
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV

      - name: Build Tier 1 Packages
        if: steps.restore-cache.outputs.cache-hit != 'true' || github.event.inputs.force_rebuild == 'true'
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building Tier 1: Quick Packages ===" -ForegroundColor Cyan
          Write-Host "These are header-only and quick-to-build packages" -ForegroundColor Gray

          # Ensure VCPKG_ROOT is set
          $vcpkgRoot = $env:VCPKG_ROOT
          if (-not $vcpkgRoot) {
            $vcpkgRoot = "${{ github.workspace }}/vcpkg"
          }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"

          Write-Host "Using vcpkg at: $vcpkgExe" -ForegroundColor Cyan

          $tier1Packages = @(
            "vcpkg-cmake",
            "vcpkg-cmake-config",
            "boost-headers",
            "boost-config",
            "boost-core",
            "boost-preprocessor",
            "boost-type-traits",
            "boost-assert",
            "boost-static-assert",
            "boost-throw-exception",
            "boost-smart-ptr",
            "boost-utility",
            "boost-optional",
            "boost-mpl",
            "boost-mp11",
            "boost-describe",
            "boost-container-hash",
            "boost-iterator",
            "boost-range",
            "boost-algorithm",
            "boost-bind",
            "boost-function",
            "boost-functional",
            "boost-tuple",
            "boost-variant",
            "boost-variant2",
            "boost-any",
            "boost-endian",
            "boost-io",
            "boost-detail",
            "boost-concept-check",
            "boost-conversion",
            "boost-numeric-conversion",
            "boost-lexical-cast",
            "boost-tokenizer",
            "boost-array",
            "boost-move",
            "boost-intrusive",
            "boost-unordered",
            "boost-container",
            "boost-pool",
            "boost-integer",
            "boost-ratio",
            "boost-winapi",
            "boost-predef",
            "boost-typeof",
            "boost-function-types",
            "boost-exception",
            "boost-type-index",
            "boost-align",
            "boost-scope",
            "boost-dynamic-bitset",
            "boost-spirit",
            "boost-phoenix",
            "boost-proto",
            "boost-fusion",
            "asio",
            "eigen3",
            "nlohmann-json",
            "cxxopts"
          )

          $total = $tier1Packages.Count
          $current = 0
          $failed = @()
          $succeeded = @()

          # Debug: Test first package with full output
          Write-Host "`nDebug: Testing vcpkg install with full output..." -ForegroundColor Magenta
          Write-Host "Working directory: $(Get-Location)" -ForegroundColor Gray
          Write-Host "VCPKG_INSTALLED_DIR: $env:VCPKG_INSTALLED_DIR" -ForegroundColor Gray
          & $vcpkgExe install "vcpkg-cmake:x64-windows" --x-install-root="$env:VCPKG_INSTALLED_DIR" 2>&1 | Tee-Object -Variable testOutput
          Write-Host "Test exit code: $LASTEXITCODE" -ForegroundColor Gray

          foreach ($pkg in $tier1Packages) {
            $current++
            Write-Host "`n[$current/$total] Installing $pkg..." -ForegroundColor Yellow

            # Use direct invocation to inherit environment variables
            $output = & $vcpkgExe install "${pkg}:x64-windows" --x-install-root="$env:VCPKG_INSTALLED_DIR" 2>&1
            $exitCode = $LASTEXITCODE

            if ($exitCode -eq 0) {
              Write-Host "  OK: $pkg installed" -ForegroundColor Green
              $succeeded += $pkg
            } else {
              Write-Host "  WARN: $pkg failed (exit code: $exitCode)" -ForegroundColor Yellow
              # Show last few lines of output for debugging
              $outputLines = ($output | Out-String).Trim()
              if ($outputLines) {
                $lastLines = ($outputLines -split "`n" | Select-Object -Last 5) -join "`n"
                Write-Host "  Output: $lastLines" -ForegroundColor Red
              }
              $failed += $pkg
            }
          }

          Write-Host "`n=== Tier 1 Summary ===" -ForegroundColor Cyan
          Write-Host "Installed: $($succeeded.Count)/$total packages" -ForegroundColor Green
          if ($failed.Count -gt 0) {
            Write-Host "Issues with: $($failed -join ', ')" -ForegroundColor Yellow
            # Exit with error if critical packages failed
            if ($failed -contains "vcpkg-cmake" -or $failed -contains "vcpkg-cmake-config") {
              Write-Host "Critical package failed - exiting" -ForegroundColor Red
              exit 1
            }
          }

      - name: Verify Tier 1 Installation
        shell: pwsh
        run: |
          Write-Host "=== Verifying Tier 1 Installation ===" -ForegroundColor Cyan

          $requiredDirs = @(
            "$env:VCPKG_INSTALLED_DIR/x64-windows/include/boost",
            "$env:VCPKG_INSTALLED_DIR/x64-windows/include/asio.hpp",
            "$env:VCPKG_INSTALLED_DIR/x64-windows/include/nlohmann",
            "$env:VCPKG_INSTALLED_DIR/x64-windows/include/Eigen"
          )

          $allGood = $true
          foreach ($dir in $requiredDirs) {
            if (Test-Path $dir) {
              Write-Host "  OK: $dir" -ForegroundColor Green
            } else {
              Write-Host "  MISSING: $dir" -ForegroundColor Red
              $allGood = $false
            }
          }

          if (-not $allGood) {
            Write-Host "`nSome packages missing - will rebuild on next run" -ForegroundColor Yellow
          } else {
            Write-Host "`nAll Tier 1 packages verified!" -ForegroundColor Green
          }

      - name: Save Tier 1 Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
            ${{ env.VCPKG_INSTALLED_DIR }}
          key: ${{ steps.cache-key.outputs.key }}

      - name: Upload Tier 1 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-tier1-installed
          path: ${{ env.VCPKG_INSTALLED_DIR }}
          retention-days: 30
          if-no-files-found: warn

  # =============================================================================
  # TIER 2: Medium packages (~15-20 min)
  # Boost compiled libs, catch2, spdlog, fmt, zeromq, curl
  # =============================================================================
  tier2-medium:
    if: ${{ github.event.inputs.tier == 'all' || github.event.inputs.tier == 'tier2' || github.event.inputs.tier == '' }}
    runs-on: windows-latest
    name: "Tier 2: Medium Packages"
    needs: tier1-quick

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Cache Key
        id: cache-key
        shell: pwsh
        run: |
          $hash = (Get-FileHash -Path vcpkg.json -Algorithm SHA256).Hash.Substring(0, 12)
          $key = "vcpkg-tier2-x64-windows-$hash"
          echo "key=$key" >> $env:GITHUB_OUTPUT

      - name: Setup Cache Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:VCPKG_INSTALLED_DIR" | Out-Null

      - name: Export GitHub Actions Cache Variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Download Tier 1 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: vcpkg-tier1-installed
          path: ${{ env.VCPKG_INSTALLED_DIR }}

      - name: Restore Tier 2 Cache
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            vcpkg-tier2-x64-windows-
            vcpkg-tier1-x64-windows-

      - name: Setup vcpkg
        id: vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '11bbc873e00e9e58d4e9dffb30b7a5493a030e0b'

      - name: Verify vcpkg Setup
        shell: pwsh
        run: |
          $vcpkgRoot = $env:VCPKG_ROOT
          if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          if (Test-Path $vcpkgExe) {
            Write-Host "vcpkg.exe found: $vcpkgExe" -ForegroundColor Green
            echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          } else {
            Write-Host "ERROR: vcpkg.exe not found" -ForegroundColor Red
            exit 1
          }

      - name: Build Tier 2 Packages
        if: steps.restore-cache.outputs.cache-hit != 'true' || github.event.inputs.force_rebuild == 'true'
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building Tier 2: Medium Packages ===" -ForegroundColor Cyan

          $vcpkgRoot = $env:VCPKG_ROOT
          if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"

          # Build in order of dependency/time
          $tier2Packages = @(
            # Boost compiled libs (~5 min total)
            "boost-atomic",
            "boost-chrono",
            "boost-date-time",
            "boost-system",
            "boost-filesystem",
            "boost-thread",
            "boost-program-options",
            "boost-regex",
            "boost-random",
            "boost-serialization",
            # Other medium packages
            "zlib",
            "fmt",
            "spdlog",
            "catch2",
            "yaml-cpp",
            "cppzmq",
            "zeromq",
            "curl",
            "tbb"
          )

          $total = $tier2Packages.Count
          $current = 0
          $failed = @()
          $succeeded = @()

          foreach ($pkg in $tier2Packages) {
            $current++
            Write-Host "`n[$current/$total] Installing $pkg..." -ForegroundColor Yellow
            $startTime = Get-Date

            # Use direct invocation to inherit environment variables
            $output = & $vcpkgExe install "${pkg}:x64-windows" --x-install-root="$env:VCPKG_INSTALLED_DIR" 2>&1
            $exitCode = $LASTEXITCODE

            $elapsed = (Get-Date) - $startTime
            if ($exitCode -eq 0) {
              Write-Host "  OK: $pkg ($([math]::Round($elapsed.TotalSeconds, 1))s)" -ForegroundColor Green
              $succeeded += $pkg
            } else {
              Write-Host "  FAILED: $pkg (exit code: $exitCode)" -ForegroundColor Red
              $failed += $pkg
            }

            # Save checkpoint every 5 packages
            if ($current % 5 -eq 0) {
              Write-Host "`n  [Checkpoint at $current packages]" -ForegroundColor Magenta
            }
          }

          Write-Host "`n=== Tier 2 Summary ===" -ForegroundColor Cyan
          Write-Host "Installed: $($succeeded.Count)/$total packages" -ForegroundColor Green
          if ($failed.Count -gt 0) {
            Write-Host "Issues with: $($failed -join ', ')" -ForegroundColor Yellow
          }

      - name: Verify Tier 2 Installation
        shell: pwsh
        run: |
          Write-Host "=== Verifying Tier 2 Installation ===" -ForegroundColor Cyan

          $libs = @(
            "boost_system",
            "boost_filesystem",
            "boost_thread",
            "boost_program_options",
            "boost_serialization",
            "fmt",
            "spdlog",
            "libzmq"
          )

          foreach ($lib in $libs) {
            $found = Get-ChildItem -Path "$env:VCPKG_INSTALLED_DIR/x64-windows/lib" -Filter "*$lib*" -ErrorAction SilentlyContinue
            if ($found) {
              Write-Host "  OK: $lib" -ForegroundColor Green
            } else {
              Write-Host "  MISSING: $lib" -ForegroundColor Yellow
            }
          }

      - name: Save Tier 2 Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: ${{ steps.cache-key.outputs.key }}

      - name: Upload Tier 2 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-tier2-installed
          path: ${{ env.VCPKG_INSTALLED_DIR }}
          retention-days: 30

  # =============================================================================
  # TIER 3: Heavy packages (~100 min)
  # grpc, rocksdb, protobuf, openssl, libpq, hwloc
  # These are built INDIVIDUALLY with checkpoints
  # =============================================================================
  tier3-heavy:
    if: ${{ github.event.inputs.tier == 'all' || github.event.inputs.tier == 'tier3' || github.event.inputs.tier == '' }}
    runs-on: windows-latest
    name: "Tier 3: Heavy Packages"
    needs: tier2-medium
    timeout-minutes: 180  # 3 hours max

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Cache Directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:VCPKG_INSTALLED_DIR" | Out-Null

      - name: Export GitHub Actions Cache Variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Download Tier 2 Artifacts
        uses: actions/download-artifact@v4
        with:
          name: vcpkg-tier2-installed
          path: ${{ env.VCPKG_INSTALLED_DIR }}

      # Restore binary cache from previous runs
      - name: Restore Heavy Packages Cache
        id: restore-heavy
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: vcpkg-tier3-heavy-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-tier3-heavy-
            vcpkg-tier2-
            vcpkg-tier1-

      - name: Setup vcpkg
        id: vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '11bbc873e00e9e58d4e9dffb30b7a5493a030e0b'

      - name: Verify vcpkg Setup
        shell: pwsh
        run: |
          $vcpkgRoot = $env:VCPKG_ROOT
          if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          if (Test-Path $vcpkgExe) {
            Write-Host "vcpkg.exe found: $vcpkgExe" -ForegroundColor Green
            echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          } else {
            Write-Host "ERROR: vcpkg.exe not found" -ForegroundColor Red
            exit 1
          }

      # =========== OPENSSL (~8 min) ===========
      - name: "Build: OpenSSL"
        id: openssl
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building OpenSSL (~8 min) ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          $startTime = Get-Date

          & $vcpkgExe install openssl:x64-windows --x-install-root="$env:VCPKG_INSTALLED_DIR"

          $elapsed = (Get-Date) - $startTime
          Write-Host "OpenSSL completed in $([math]::Round($elapsed.TotalMinutes, 1)) minutes" -ForegroundColor Green

          # Verify
          if (Test-Path "$env:VCPKG_INSTALLED_DIR/x64-windows/lib/libssl.lib") {
            Write-Host "OpenSSL verified!" -ForegroundColor Green
            echo "status=success" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "OpenSSL verification failed" -ForegroundColor Red
            echo "status=failed" >> $env:GITHUB_OUTPUT
          }

      - name: "Checkpoint: After OpenSSL"
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: vcpkg-checkpoint-openssl-${{ hashFiles('vcpkg.json') }}-${{ github.run_id }}

      # =========== ABSEIL (~2 min) ===========
      - name: "Build: Abseil"
        id: abseil
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building Abseil (~2 min) ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          $startTime = Get-Date

          & $vcpkgExe install abseil:x64-windows --x-install-root="$env:VCPKG_INSTALLED_DIR"

          $elapsed = (Get-Date) - $startTime
          Write-Host "Abseil completed in $([math]::Round($elapsed.TotalMinutes, 1)) minutes" -ForegroundColor Green

      # =========== RE2 (~0.5 min) ===========
      - name: "Build: RE2"
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building RE2 ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          & $vcpkgExe install re2:x64-windows --x-install-root="$env:VCPKG_INSTALLED_DIR"

      # =========== C-ARES (~1.5 min) ===========
      - name: "Build: c-ares"
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building c-ares ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          & $vcpkgExe install c-ares:x64-windows --x-install-root="$env:VCPKG_INSTALLED_DIR"

      # =========== PROTOBUF (~13 min) ===========
      - name: "Build: Protobuf"
        id: protobuf
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building Protobuf (~13 min) ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          $startTime = Get-Date

          & $vcpkgExe install protobuf:x64-windows --x-install-root="$env:VCPKG_INSTALLED_DIR"

          $elapsed = (Get-Date) - $startTime
          Write-Host "Protobuf completed in $([math]::Round($elapsed.TotalMinutes, 1)) minutes" -ForegroundColor Green

          # Verify protoc exists
          if (Test-Path "$env:VCPKG_INSTALLED_DIR/x64-windows/tools/protobuf/protoc.exe") {
            Write-Host "Protobuf verified (protoc found)!" -ForegroundColor Green
            echo "status=success" >> $env:GITHUB_OUTPUT
          } else {
            echo "status=failed" >> $env:GITHUB_OUTPUT
          }

      - name: "Checkpoint: After Protobuf"
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: vcpkg-checkpoint-protobuf-${{ hashFiles('vcpkg.json') }}-${{ github.run_id }}

      # =========== GRPC (~60 min) - THE BIG ONE ===========
      - name: "Build: gRPC (this takes ~60 minutes)"
        id: grpc
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building gRPC (~60 min) ===" -ForegroundColor Cyan
          Write-Host "This is the longest package - go grab a coffee!" -ForegroundColor Yellow
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          $startTime = Get-Date

          & $vcpkgExe install "grpc[codegen,core]:x64-windows" --x-install-root="$env:VCPKG_INSTALLED_DIR"

          $elapsed = (Get-Date) - $startTime
          Write-Host "gRPC completed in $([math]::Round($elapsed.TotalMinutes, 1)) minutes" -ForegroundColor Green

          # Verify
          if (Test-Path "$env:VCPKG_INSTALLED_DIR/x64-windows/tools/grpc/grpc_cpp_plugin.exe") {
            Write-Host "gRPC verified (grpc_cpp_plugin found)!" -ForegroundColor Green
            echo "status=success" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "gRPC verification failed" -ForegroundColor Red
            echo "status=failed" >> $env:GITHUB_OUTPUT
          }

      - name: "Checkpoint: After gRPC"
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: vcpkg-checkpoint-grpc-${{ hashFiles('vcpkg.json') }}-${{ github.run_id }}

      # =========== HWLOC (~7 min) ===========
      - name: "Build: hwloc"
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building hwloc (~7 min) ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          & $vcpkgExe install hwloc:x64-windows --x-install-root="$env:VCPKG_INSTALLED_DIR"

      # =========== LIBPQ (~1.5 min) ===========
      - name: "Build: libpq (PostgreSQL)"
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building libpq ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          & $vcpkgExe install "libpq[core,lz4,openssl,zlib]:x64-windows" --x-install-root="$env:VCPKG_INSTALLED_DIR"

      # =========== LZ4 (for RocksDB) ===========
      - name: "Build: lz4"
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building lz4 ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          & $vcpkgExe install lz4:x64-windows --x-install-root="$env:VCPKG_INSTALLED_DIR"

      # =========== ROCKSDB (~28 min) ===========
      - name: "Build: RocksDB"
        id: rocksdb
        shell: pwsh
        env:
          VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
        run: |
          Write-Host "=== Building RocksDB (~28 min) ===" -ForegroundColor Cyan
          $vcpkgRoot = $env:VCPKG_ROOT; if (-not $vcpkgRoot) { $vcpkgRoot = "${{ github.workspace }}/vcpkg" }
          $vcpkgExe = Join-Path $vcpkgRoot "vcpkg.exe"
          $startTime = Get-Date

          & $vcpkgExe install "rocksdb[core,zlib]:x64-windows" --x-install-root="$env:VCPKG_INSTALLED_DIR"

          $elapsed = (Get-Date) - $startTime
          Write-Host "RocksDB completed in $([math]::Round($elapsed.TotalMinutes, 1)) minutes" -ForegroundColor Green

          # Verify
          if (Test-Path "$env:VCPKG_INSTALLED_DIR/x64-windows/lib/rocksdb.lib") {
            Write-Host "RocksDB verified!" -ForegroundColor Green
            echo "status=success" >> $env:GITHUB_OUTPUT
          } else {
            echo "status=failed" >> $env:GITHUB_OUTPUT
          }

      - name: "Checkpoint: After RocksDB"
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: vcpkg-checkpoint-rocksdb-${{ hashFiles('vcpkg.json') }}-${{ github.run_id }}

      # =========== FINAL SAVE ===========
      - name: Save Final Tier 3 Cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: vcpkg-tier3-heavy-${{ hashFiles('vcpkg.json') }}

      - name: Upload Tier 3 Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-tier3-installed
          path: ${{ env.VCPKG_INSTALLED_DIR }}
          retention-days: 30

      - name: Tier 3 Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "    TIER 3 HEAVY PACKAGES SUMMARY" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          $results = @{
            "OpenSSL" = "${{ steps.openssl.outputs.status }}"
            "Protobuf" = "${{ steps.protobuf.outputs.status }}"
            "gRPC" = "${{ steps.grpc.outputs.status }}"
            "RocksDB" = "${{ steps.rocksdb.outputs.status }}"
          }

          foreach ($pkg in $results.Keys) {
            $status = $results[$pkg]
            if ($status -eq "success") {
              Write-Host "  OK: $pkg" -ForegroundColor Green
            } else {
              Write-Host "  ?: $pkg (check logs)" -ForegroundColor Yellow
            }
          }

          Write-Host "`nBinary cache saved - next run will be MUCH faster!" -ForegroundColor Magenta

  # =============================================================================
  # FINAL: Consolidate and create release artifact
  # =============================================================================
  consolidate:
    runs-on: windows-latest
    name: "Consolidate All Packages"
    needs: [tier1-quick, tier2-medium, tier3-heavy]
    if: always()

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Tier Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-tiers

      - name: Consolidate Installed Packages
        shell: pwsh
        run: |
          Write-Host "=== Consolidating All Tiers ===" -ForegroundColor Cyan

          New-Item -ItemType Directory -Force -Path "vcpkg_installed_complete/x64-windows" | Out-Null

          # Merge all tiers (later tiers include earlier ones)
          $tiers = @("vcpkg-tier1-installed", "vcpkg-tier2-installed", "vcpkg-tier3-installed")

          foreach ($tier in $tiers) {
            $tierPath = "all-tiers/$tier"
            if (Test-Path $tierPath) {
              Write-Host "Merging $tier..." -ForegroundColor Yellow
              Copy-Item -Path "$tierPath/*" -Destination "vcpkg_installed_complete/" -Recurse -Force
            }
          }

          # Count what we have
          $includeCount = (Get-ChildItem -Path "vcpkg_installed_complete/x64-windows/include" -Directory -ErrorAction SilentlyContinue).Count
          $libCount = (Get-ChildItem -Path "vcpkg_installed_complete/x64-windows/lib" -Filter "*.lib" -ErrorAction SilentlyContinue).Count

          Write-Host "`nConsolidated package stats:" -ForegroundColor Cyan
          Write-Host "  Include directories: $includeCount" -ForegroundColor Green
          Write-Host "  Library files: $libCount" -ForegroundColor Green

      - name: Create Package Manifest
        shell: pwsh
        run: |
          $manifest = @{
            "created" = (Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
            "vcpkg_baseline" = "11bbc873e00e9e58d4e9dffb30b7a5493a030e0b"
            "triplet" = "x64-windows"
            "tiers" = @{
              "tier1" = "${{ needs.tier1-quick.result }}"
              "tier2" = "${{ needs.tier2-medium.result }}"
              "tier3" = "${{ needs.tier3-heavy.result }}"
            }
            "packages" = @{
              "boost" = "installed"
              "grpc" = "installed"
              "rocksdb" = "installed"
              "protobuf" = "installed"
              "openssl" = "installed"
            }
          }

          $manifest | ConvertTo-Json -Depth 4 | Out-File "vcpkg_installed_complete/manifest.json"

          Write-Host "Manifest created:" -ForegroundColor Cyan
          Get-Content "vcpkg_installed_complete/manifest.json"

      - name: Upload Complete vcpkg Installation
        uses: actions/upload-artifact@v4
        with:
          name: vcpkg-complete-x64-windows
          path: vcpkg_installed_complete/
          retention-days: 90
          compression-level: 9

      - name: Final Summary
        shell: pwsh
        run: |
          Write-Host "`n" -ForegroundColor Cyan
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host "     VCPKG PREBUILD COMPLETE" -ForegroundColor Green
          Write-Host "================================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Tier Results:" -ForegroundColor Yellow
          Write-Host "  Tier 1 (Quick):  ${{ needs.tier1-quick.result }}"
          Write-Host "  Tier 2 (Medium): ${{ needs.tier2-medium.result }}"
          Write-Host "  Tier 3 (Heavy):  ${{ needs.tier3-heavy.result }}"
          Write-Host ""
          Write-Host "Artifact: vcpkg-complete-x64-windows" -ForegroundColor Cyan
          Write-Host "Retention: 90 days" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Next Steps:" -ForegroundColor Yellow
          Write-Host "  1. Download artifact for local use, OR"
          Write-Host "  2. Reference in occ-win-build.yml workflow"
          Write-Host ""
          Write-Host "Future runs will use GitHub Actions cache" -ForegroundColor Magenta
          Write-Host "(binary packages cached - no rebuild needed)" -ForegroundColor Magenta
