name: Build Debian Packages

# This workflow builds Debian packages for OpenCog components
# Following the dependency order and using dpkg-buildpackage

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  # Stage 1: Build cogutil (Foundation)
  build-cogutil:
    runs-on: ubuntu-latest
    name: Build cogutil Debian Package
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          doxygen \
          graphviz \
          python3-dev \
          patchelf
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/cogutil/debian" ]; then
          cp -r opencog-debian/cogutil/debian cogutil/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/cogutil"
        fi
    
    - name: Build cogutil Package
      run: |
        cd cogutil
        dpkg-buildpackage -us -uc -b
    
    - name: List Generated Packages
      if: always()
      run: |
        echo "ðŸ“¦ Generated Debian packages:"
        ls -lh *.deb 2>/dev/null || echo "No .deb files found in root"
    
    - name: Upload cogutil Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: cogutil-debian-packages
        path: "*.deb"
        retention-days: 7
    
    - name: Install cogutil for next stages
      if: success()
      run: |
        sudo dpkg -i *.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y

  # Stage 2: Build atomspace (requires cogutil)
  build-atomspace:
    runs-on: ubuntu-latest
    name: Build atomspace Debian Package
    needs: build-cogutil
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          ghc \
          unixodbc-dev \
          libzmq3-dev \
          libprotobuf-dev \
          libpq-dev \
          postgresql \
          postgresql-client \
          patchelf \
          cython3 \
          python3-dev \
          valgrind \
          haskell-stack \
          libgearman-dev \
          python3-nose \
          odbc-postgresql \
          doxygen \
          graphviz \
          protobuf-compiler
    
    - name: Download cogutil Packages
      uses: actions/download-artifact@v4
      with:
        name: cogutil-debian-packages
    
    - name: Install cogutil
      run: |
        sudo dpkg -i *.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/atomspace/debian" ]; then
          cp -r opencog-debian/atomspace/debian atomspace/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/atomspace"
        fi
    
    - name: Build atomspace Package
      run: |
        cd atomspace
        dpkg-buildpackage -us -uc -b
    
    - name: List Generated Packages
      if: always()
      run: |
        echo "ðŸ“¦ Generated Debian packages:"
        ls -lh *.deb 2>/dev/null || echo "No .deb files found in root"
    
    - name: Upload atomspace Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: atomspace-debian-packages
        path: "*.deb"
        retention-days: 7
    
    - name: Install atomspace for next stages
      if: success()
      run: |
        sudo dpkg -i *.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y

  # Stage 3: Build unify (requires cogutil, atomspace)
  build-unify:
    runs-on: ubuntu-latest
    name: Build unify Debian Package
    needs: build-atomspace
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          python3-dev
    
    - name: Download cogutil Packages
      uses: actions/download-artifact@v4
      with:
        name: cogutil-debian-packages
        path: ./deps/cogutil
    
    - name: Download atomspace Packages
      uses: actions/download-artifact@v4
      with:
        name: atomspace-debian-packages
        path: ./deps/atomspace
    
    - name: Install Dependencies
      run: |
        sudo dpkg -i ./deps/cogutil/*.deb || echo "Some packages failed to install"
        sudo dpkg -i ./deps/atomspace/*.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/unify/debian" ]; then
          cp -r opencog-debian/unify/debian unify/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/unify"
        fi
    
    - name: Build unify Package
      run: |
        cd unify
        dpkg-buildpackage -us -uc -b
    
    - name: List Generated Packages
      if: always()
      run: |
        echo "ðŸ“¦ Generated Debian packages:"
        ls -lh *.deb 2>/dev/null || echo "No .deb files found"
    
    - name: Upload unify Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: unify-debian-packages
        path: "*.deb"
        retention-days: 7

  # Stage 4: Build ure (requires cogutil, atomspace, unify)
  build-ure:
    runs-on: ubuntu-latest
    name: Build ure Debian Package
    needs: build-unify
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          python3-dev
    
    - name: Download Previous Packages
      uses: actions/download-artifact@v4
      with:
        pattern: '*-debian-packages'
        path: ./deps
        merge-multiple: true
    
    - name: Install Dependencies
      run: |
        sudo dpkg -i ./deps/*.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/ure/debian" ]; then
          cp -r opencog-debian/ure/debian ure/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/ure"
        fi
    
    - name: Build ure Package
      run: |
        cd ure
        dpkg-buildpackage -us -uc -b
    
    - name: Upload ure Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ure-debian-packages
        path: "*.deb"
        retention-days: 7

  # Stage 5: Build cogserver (requires cogutil, atomspace)
  build-cogserver:
    runs-on: ubuntu-latest
    name: Build cogserver Debian Package
    needs: build-atomspace
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          python3-dev
    
    - name: Download Previous Packages
      uses: actions/download-artifact@v4
      with:
        pattern: '*-debian-packages'
        path: ./deps
        merge-multiple: true
    
    - name: Install Dependencies
      run: |
        sudo dpkg -i ./deps/*.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/cogserver/debian" ]; then
          cp -r opencog-debian/cogserver/debian cogserver/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/cogserver"
        fi
    
    - name: Build cogserver Package
      run: |
        cd cogserver
        dpkg-buildpackage -us -uc -b
    
    - name: Upload cogserver Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: cogserver-debian-packages
        path: "*.deb"
        retention-days: 7

  # Stage 6: Build attention (requires cogutil, atomspace, cogserver)
  build-attention:
    runs-on: ubuntu-latest
    name: Build attention Debian Package
    needs: build-cogserver
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          python3-dev
    
    - name: Download Previous Packages
      uses: actions/download-artifact@v4
      with:
        pattern: '*-debian-packages'
        path: ./deps
        merge-multiple: true
    
    - name: Install Dependencies
      run: |
        sudo dpkg -i ./deps/*.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/attention/debian" ]; then
          cp -r opencog-debian/attention/debian attention/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/attention"
        fi
    
    - name: Build attention Package
      run: |
        cd attention
        dpkg-buildpackage -us -uc -b
    
    - name: Upload attention Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: attention-debian-packages
        path: "*.deb"
        retention-days: 7

  # Stage 7: Build moses (foundation component)
  build-moses:
    runs-on: ubuntu-latest
    name: Build moses Debian Package
    needs: build-cogutil
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          python3-dev
    
    - name: Download cogutil Packages
      uses: actions/download-artifact@v4
      with:
        name: cogutil-debian-packages
    
    - name: Install Dependencies
      run: |
        sudo dpkg -i *.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/moses/debian" ]; then
          cp -r opencog-debian/moses/debian moses/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/moses"
        fi
    
    - name: Build moses Package
      run: |
        cd moses
        dpkg-buildpackage -us -uc -b
    
    - name: Upload moses Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: moses-debian-packages
        path: "*.deb"
        retention-days: 7

  # Stage 8: Build asmoses (requires moses, atomspace)
  build-asmoses:
    runs-on: ubuntu-latest
    name: Build asmoses Debian Package
    needs: [build-moses, build-atomspace]
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          python3-dev
    
    - name: Download Previous Packages
      uses: actions/download-artifact@v4
      with:
        pattern: '*-debian-packages'
        path: ./deps
        merge-multiple: true
    
    - name: Install Dependencies
      run: |
        sudo dpkg -i ./deps/*.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/asmoses/debian" ]; then
          cp -r opencog-debian/asmoses/debian asmoses/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/asmoses"
        fi
    
    - name: Build asmoses Package
      run: |
        cd asmoses
        dpkg-buildpackage -us -uc -b
    
    - name: Upload asmoses Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: asmoses-debian-packages
        path: "*.deb"
        retention-days: 7

  # Stage 9: Build miner (requires cogutil, atomspace, ure)
  build-miner:
    runs-on: ubuntu-latest
    name: Build miner Debian Package
    needs: build-ure
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          python3-dev
    
    - name: Download Previous Packages
      uses: actions/download-artifact@v4
      with:
        pattern: '*-debian-packages'
        path: ./deps
        merge-multiple: true
    
    - name: Install Dependencies
      run: |
        sudo dpkg -i ./deps/*.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/miner/debian" ]; then
          cp -r opencog-debian/miner/debian miner/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/miner"
        fi
    
    - name: Build miner Package
      run: |
        cd miner
        dpkg-buildpackage -us -uc -b
    
    - name: Upload miner Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: miner-debian-packages
        path: "*.deb"
        retention-days: 7

  # Stage 10: Build pln (requires cogutil, atomspace, ure)
  build-pln:
    runs-on: ubuntu-latest
    name: Build pln Debian Package
    needs: build-ure
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: Install Prerequisites
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          debhelper \
          dpkg-dev \
          cmake \
          g++ \
          guile-3.0-dev \
          libboost-all-dev \
          binutils-dev \
          libiberty-dev \
          cxxtest \
          python3-dev
    
    - name: Download Previous Packages
      uses: actions/download-artifact@v4
      with:
        pattern: '*-debian-packages'
        path: ./deps
        merge-multiple: true
    
    - name: Install Dependencies
      run: |
        sudo dpkg -i ./deps/*.deb || echo "Some packages failed to install"
        sudo apt-get install -f -y
    
    - name: Copy Debian packaging files
      run: |
        if [ -d "opencog-debian/pln/debian" ]; then
          cp -r opencog-debian/pln/debian pln/
          echo "âœ… Copied existing debian/ directory"
        else
          echo "âš ï¸  No debian/ directory found in opencog-debian/pln"
        fi
    
    - name: Build pln Package
      run: |
        cd pln
        dpkg-buildpackage -us -uc -b
    
    - name: Upload pln Packages
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: pln-debian-packages
        path: "*.deb"
        retention-days: 7

  # Final Stage: Generate Build Summary
  generate-summary:
    runs-on: ubuntu-latest
    name: Generate Build Summary
    needs: [build-cogutil, build-atomspace, build-unify, build-ure, build-cogserver, build-attention, build-moses, build-asmoses, build-miner, build-pln]
    if: always()
    
    steps:
    - name: Download All Packages
      uses: actions/download-artifact@v4
      with:
        pattern: '*-debian-packages'
        path: ./all-packages
    
    - name: Generate Summary
      run: |
        echo "# ðŸ“¦ Debian Package Build Summary" > $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Built Packages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count packages (check if directory exists first)
        if [ -d "./all-packages" ]; then
          total_debs=$(find ./all-packages -name "*.deb" 2>/dev/null | wc -l)
        else
          total_debs=0
        fi
        echo "**Total packages built:** $total_debs" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # List all packages
        echo "### Package List" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Package | Size |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|---------|------|" >> $GITHUB_STEP_SUMMARY
        
        for component_dir in ./all-packages/*; do
          if [ -d "$component_dir" ]; then
            component=$(basename "$component_dir" | sed 's/-debian-packages//')
            for deb in "$component_dir"/*.deb; do
              if [ -f "$deb" ]; then
                package=$(basename "$deb")
                size=$(du -h "$deb" | cut -f1)
                echo "| $component | $package | $size |" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Installation Instructions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Download artifacts from GitHub Actions" >> $GITHUB_STEP_SUMMARY
        echo "# Then install in dependency order:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# 1. Install cogutil" >> $GITHUB_STEP_SUMMARY
        echo "sudo dpkg -i *cogutil*.deb" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# 2. Install atomspace" >> $GITHUB_STEP_SUMMARY
        echo "sudo dpkg -i *atomspace*.deb" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# 3. Install remaining packages" >> $GITHUB_STEP_SUMMARY
        echo "sudo dpkg -i *.deb" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# 4. Fix any dependency issues" >> $GITHUB_STEP_SUMMARY
        echo "sudo apt-get install -f -y" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*Generated by debian-packages.yml workflow*" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload All Packages
      uses: actions/upload-artifact@v4
      with:
        name: all-debian-packages
        path: ./all-packages/**/*.deb
        retention-days: 30
