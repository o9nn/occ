name: OCC Windows Build - Fixed

# Windows-specific build workflow for OpenCog Collection (OCC) monorepo
# OPTIMIZED: Uses prebuilt vcpkg cache from vcpkg-prebuild.yml workflow
# Builds components in dependency order: cogutil -> atomspace -> cogserver -> attention -> unify -> ure -> miner -> moses
# Produces fully functional Windows binaries for Electron desktop app integration
#
# DEPENDENCY CACHING STRATEGY:
# - Uses GitHub Actions native vcpkg binary caching (VCPKG_BINARY_SOURCES)
# - Heavy packages (gRPC, RocksDB, Protobuf) are prebuilt by vcpkg-prebuild.yml
# - First build after cache: ~2 hours, subsequent builds: ~5-10 minutes

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'Skip vcpkg cache (force rebuild)'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: windows-build-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  CMAKE_GENERATOR: "Visual Studio 17 2022"
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg_cache
  VCPKG_INSTALLED_DIR: ${{ github.workspace }}/vcpkg_installed
  # Enable GitHub Actions native vcpkg binary caching
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  # Stage 1: Build CogUtil (Foundation)
  build-cogutil:
    runs-on: windows-latest
    name: Build CogUtil (Windows)

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Create vcpkg cache directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
        Write-Host "vcpkg cache directory created at $env:VCPKG_DEFAULT_BINARY_CACHE" -ForegroundColor Green

    # CRITICAL: Export GitHub Actions cache variables for vcpkg binary caching
    - name: Export GitHub Actions Cache Variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    # Try to download prebuilt vcpkg packages from prebuild workflow
    - name: Try Download Prebuilt vcpkg Packages
      id: download-prebuilt
      continue-on-error: true
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: vcpkg-prebuild.yml
        name: vcpkg-complete-x64-windows
        path: ${{ env.VCPKG_INSTALLED_DIR }}
        search_artifacts: true
        if_no_artifact_found: warn

    - name: Check Prebuilt Status
      id: prebuilt-check
      shell: pwsh
      run: |
        if (Test-Path "$env:VCPKG_INSTALLED_DIR/x64-windows/lib") {
          $libCount = (Get-ChildItem -Path "$env:VCPKG_INSTALLED_DIR/x64-windows/lib" -Filter "*.lib" -ErrorAction SilentlyContinue).Count
          Write-Host "Found $libCount prebuilt libraries" -ForegroundColor Green
          if ($libCount -gt 50) {
            Write-Host "Using prebuilt vcpkg packages!" -ForegroundColor Green
            echo "has_prebuilt=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "has_prebuilt=false" >> $env:GITHUB_OUTPUT
          }
        } else {
          Write-Host "No prebuilt packages found - will build from cache/source" -ForegroundColor Yellow
          echo "has_prebuilt=false" >> $env:GITHUB_OUTPUT
        }

    - name: Cache vcpkg binary packages
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-binary-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}-v3
        restore-keys: |
          vcpkg-binary-${{ runner.os }}-v3
          vcpkg-binary-${{ runner.os }}-
          vcpkg-tier3-heavy-
          vcpkg-tier2-
          vcpkg-tier1-

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgJsonGlob: 'vcpkg.json'
        vcpkgGitCommitId: '11bbc873e00e9e58d4e9dffb30b7a5493a030e0b'

    - name: Install Dependencies
      if: steps.prebuilt-check.outputs.has_prebuilt != 'true'
      shell: pwsh
      env:
        VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite;files,${{ env.VCPKG_DEFAULT_BINARY_CACHE }},readwrite"
      run: |
        Write-Host "=== Installing Dependencies via vcpkg ===" -ForegroundColor Cyan
        Write-Host "Using GitHub Actions binary cache - prebuilt packages will restore instantly" -ForegroundColor Yellow

        $startTime = Get-Date

        # Install all required dependencies using manifest mode
        & "$env:VCPKG_ROOT/vcpkg.exe" install --triplet x64-windows --x-install-root="$env:VCPKG_INSTALLED_DIR"

        $elapsed = (Get-Date) - $startTime
        Write-Host "`nDependency installation took $([math]::Round($elapsed.TotalMinutes, 1)) minutes" -ForegroundColor Cyan

        # Verify boost installation
        Write-Host "`n=== Verifying Boost Installation ===" -ForegroundColor Cyan
        $boostDirs = Get-ChildItem -Path "$env:VCPKG_INSTALLED_DIR/x64-windows/share" -Filter "boost*" -Directory -ErrorAction SilentlyContinue
        foreach ($dir in $boostDirs) {
          Write-Host "  Found: $($dir.Name)" -ForegroundColor Green
        }

        Write-Host "`nDependencies installed successfully" -ForegroundColor Green

    - name: Verify Dependencies (Prebuilt)
      if: steps.prebuilt-check.outputs.has_prebuilt == 'true'
      shell: pwsh
      run: |
        Write-Host "=== Using Prebuilt Dependencies ===" -ForegroundColor Green
        Write-Host "Skipping vcpkg install - using artifacts from vcpkg-prebuild.yml" -ForegroundColor Yellow

        $libs = Get-ChildItem -Path "$env:VCPKG_INSTALLED_DIR/x64-windows/lib" -Filter "*.lib" -ErrorAction SilentlyContinue
        Write-Host "Available libraries: $($libs.Count)" -ForegroundColor Cyan
    
    - name: Configure CogUtil
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Configuring CogUtil ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path cogutil/build | Out-Null
        Set-Location cogutil/build
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE/install" `
          -DVCPKG_INSTALLED_DIR="$env:VCPKG_INSTALLED_DIR"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build CogUtil
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Building CogUtil ===" -ForegroundColor Cyan
        Set-Location cogutil/build
        cmake --build . --config $env:BUILD_TYPE --parallel 4
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Build CogUtil Tests
      shell: pwsh
      run: |
        Write-Host "=== Building CogUtil Tests ===" -ForegroundColor Cyan
        Set-Location cogutil/build
        cmake --build . --config $env:BUILD_TYPE --target tests --parallel 4
        Write-Host "Test build complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Run CogUtil Tests
      shell: pwsh
      run: |
        Write-Host "=== Running CogUtil Tests ===" -ForegroundColor Cyan
        Set-Location cogutil/build
        ctest -C $env:BUILD_TYPE --output-on-failure --timeout 300
        Write-Host "Tests complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Install CogUtil
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Installing CogUtil ===" -ForegroundColor Cyan
        Set-Location cogutil/build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload CogUtil Build
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cogutil-build-windows
        path: |
          install/**
        retention-days: 90
    
    - name: Upload vcpkg installed
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: vcpkg-installed-cogutil
        path: |
          vcpkg_installed/**
        retention-days: 90

  # Stage 2: Build AtomSpace (depends on CogUtil)
  build-atomspace:
    runs-on: windows-latest
    name: Build AtomSpace (Windows)
    needs: build-cogutil

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Download CogUtil Build
      uses: actions/download-artifact@v4
      with:
        name: cogutil-build-windows
        path: install

    - name: Download vcpkg installed
      uses: actions/download-artifact@v4
      with:
        name: vcpkg-installed-cogutil
        path: vcpkg_installed

    - name: Create vcpkg cache directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
        Write-Host "vcpkg cache directory created" -ForegroundColor Green

    # CRITICAL: Export GitHub Actions cache variables for vcpkg binary caching
    - name: Export GitHub Actions Cache Variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Cache vcpkg binary packages
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-binary-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}-v3
        restore-keys: |
          vcpkg-binary-${{ runner.os }}-v3
          vcpkg-binary-${{ runner.os }}-

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgJsonGlob: 'vcpkg.json'
        vcpkgGitCommitId: '11bbc873e00e9e58d4e9dffb30b7a5493a030e0b'
    
    - name: Configure AtomSpace
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Configuring AtomSpace ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path atomspace/build | Out-Null
        Set-Location atomspace/build
        
        # Add CogUtil to CMAKE_PREFIX_PATH
        $env:CMAKE_PREFIX_PATH = "$env:GITHUB_WORKSPACE/install"
        
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE/install" `
          -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH" `
          -DVCPKG_INSTALLED_DIR="$env:VCPKG_INSTALLED_DIR"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build AtomSpace
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Building AtomSpace ===" -ForegroundColor Cyan
        Set-Location atomspace/build
        cmake --build . --config $env:BUILD_TYPE --parallel 4
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Build AtomSpace Tests
      shell: pwsh
      run: |
        Write-Host "=== Building AtomSpace Tests ===" -ForegroundColor Cyan
        Set-Location atomspace/build
        cmake --build . --config $env:BUILD_TYPE --target tests --parallel 4
        Write-Host "Test build complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Run AtomSpace Tests
      shell: pwsh
      run: |
        Write-Host "=== Running AtomSpace Tests ===" -ForegroundColor Cyan
        Set-Location atomspace/build
        
        # Add CogUtil DLLs to PATH
        $env:PATH = "$env:GITHUB_WORKSPACE/install/bin;$env:VCPKG_INSTALLED_DIR/x64-windows/bin;$env:PATH"
        
        ctest -C $env:BUILD_TYPE --output-on-failure --timeout 300
        Write-Host "Tests complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Install AtomSpace
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Installing AtomSpace ===" -ForegroundColor Cyan
        Set-Location atomspace/build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload AtomSpace Build
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: atomspace-build-windows
        path: |
          install/**
        retention-days: 90

  # Stage 3: Build Moses (depends on CogUtil)
  build-moses:
    runs-on: windows-latest
    name: Build Moses (Windows)
    needs: build-cogutil

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Download CogUtil Build
      uses: actions/download-artifact@v4
      with:
        name: cogutil-build-windows
        path: install

    - name: Download vcpkg installed
      uses: actions/download-artifact@v4
      with:
        name: vcpkg-installed-cogutil
        path: vcpkg_installed

    - name: Create vcpkg cache directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
        Write-Host "vcpkg cache directory created" -ForegroundColor Green

    # CRITICAL: Export GitHub Actions cache variables for vcpkg binary caching
    - name: Export GitHub Actions Cache Variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Cache vcpkg binary packages
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-binary-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}-v3
        restore-keys: |
          vcpkg-binary-${{ runner.os }}-v3
          vcpkg-binary-${{ runner.os }}-

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgJsonGlob: 'vcpkg.json'
        vcpkgGitCommitId: '11bbc873e00e9e58d4e9dffb30b7a5493a030e0b'
    
    - name: Verify Boost Serialization
      shell: pwsh
      run: |
        Write-Host "=== Verifying Boost Serialization ===" -ForegroundColor Cyan
        
        $boostSerializationPath = "$env:VCPKG_INSTALLED_DIR/x64-windows/share/boost-serialization"
        if (Test-Path $boostSerializationPath) {
          Write-Host "‚úì boost-serialization found at: $boostSerializationPath" -ForegroundColor Green
          Get-ChildItem $boostSerializationPath
        } else {
          Write-Host "‚úó boost-serialization NOT found!" -ForegroundColor Red
          Write-Host "Installing boost-serialization explicitly..." -ForegroundColor Yellow
          & "$env:VCPKG_ROOT/vcpkg.exe" install boost-serialization:x64-windows
        }
        
        # List all boost components
        Write-Host "`n=== Installed Boost Components ===" -ForegroundColor Cyan
        Get-ChildItem -Path "$env:VCPKG_INSTALLED_DIR/x64-windows/share" -Filter "boost*" -Directory | ForEach-Object {
          Write-Host "  $($_.Name)" -ForegroundColor Green
        }
    
    - name: Configure Moses
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Configuring Moses ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path moses/build | Out-Null
        Set-Location moses/build
        
        # Add CogUtil to CMAKE_PREFIX_PATH
        $env:CMAKE_PREFIX_PATH = "$env:GITHUB_WORKSPACE/install;$env:VCPKG_INSTALLED_DIR/x64-windows"
        
        # Set Boost_DIR to help CMake find boost
        $env:Boost_DIR = "$env:VCPKG_INSTALLED_DIR/x64-windows/share/boost"
        
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE/install" `
          -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH" `
          -DVCPKG_INSTALLED_DIR="$env:VCPKG_INSTALLED_DIR" `
          -DBoost_NO_BOOST_CMAKE=ON `
          -DBoost_DIR="$env:Boost_DIR" `
          -DBOOST_ROOT="$env:VCPKG_INSTALLED_DIR/x64-windows" `
          -DBoost_INCLUDE_DIR="$env:VCPKG_INSTALLED_DIR/x64-windows/include" `
          -DBoost_LIBRARY_DIR="$env:VCPKG_INSTALLED_DIR/x64-windows/lib"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build Moses
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Building Moses ===" -ForegroundColor Cyan
        Set-Location moses/build
        cmake --build . --config $env:BUILD_TYPE --parallel 4
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Install Moses
      continue-on-error: true
      shell: pwsh
      run: |
        Write-Host "=== Installing Moses ===" -ForegroundColor Cyan
        Set-Location moses/build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload Moses Build
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: moses-build-windows
        path: |
          install/**
        retention-days: 90

  # Stage 4: Build CogServer (depends on AtomSpace)
  build-cogserver:
    runs-on: windows-latest
    name: Build CogServer (Windows)
    needs: build-atomspace

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Download AtomSpace Build
      uses: actions/download-artifact@v4
      with:
        name: atomspace-build-windows
        path: install

    - name: Download vcpkg installed
      uses: actions/download-artifact@v4
      with:
        name: vcpkg-installed-cogutil
        path: vcpkg_installed

    - name: Create vcpkg cache directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null

    # CRITICAL: Export GitHub Actions cache variables for vcpkg binary caching
    - name: Export GitHub Actions Cache Variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Cache vcpkg binary packages
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-binary-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}-v3
        restore-keys: |
          vcpkg-binary-${{ runner.os }}-v3
          vcpkg-binary-${{ runner.os }}-

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgJsonGlob: 'vcpkg.json'
        vcpkgGitCommitId: '11bbc873e00e9e58d4e9dffb30b7a5493a030e0b'
    
    - name: Configure CogServer
      shell: pwsh
      run: |
        Write-Host "=== Configuring CogServer ===" -ForegroundColor Cyan
        
        if (-not (Test-Path "cogserver")) {
          Write-Host "‚ö† CogServer directory not found - skipping" -ForegroundColor Yellow
          exit 0
        }
        
        New-Item -ItemType Directory -Force -Path cogserver/build | Out-Null
        Set-Location cogserver/build
        
        $env:CMAKE_PREFIX_PATH = "$env:GITHUB_WORKSPACE/install"
        
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE/install" `
          -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH" `
          -DVCPKG_INSTALLED_DIR="$env:VCPKG_INSTALLED_DIR"
        Write-Host "Configuration complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Build CogServer
      shell: pwsh
      run: |
        if (-not (Test-Path "cogserver/build")) {
          Write-Host "‚ö† CogServer build directory not found - skipping" -ForegroundColor Yellow
          exit 0
        }
        
        Write-Host "=== Building CogServer ===" -ForegroundColor Cyan
        Set-Location cogserver/build
        cmake --build . --config $env:BUILD_TYPE --parallel 4
        Write-Host "Build complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Install CogServer
      shell: pwsh
      run: |
        if (-not (Test-Path "cogserver/build")) {
          Write-Host "‚ö† CogServer build directory not found - skipping" -ForegroundColor Yellow
          exit 0
        }
        
        Write-Host "=== Installing CogServer ===" -ForegroundColor Cyan
        Set-Location cogserver/build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Upload CogServer Build
      uses: actions/upload-artifact@v4
      with:
        name: cogserver-build-windows
        path: |
          install/**
        retention-days: 90
      continue-on-error: true

  # Final Stage: Consolidate All Builds
  consolidate-builds:
    runs-on: windows-latest
    name: Consolidate Windows Builds
    needs: [build-cogutil, build-atomspace, build-moses, build-cogserver]
    if: always()
    
    steps:
    - name: Download All Builds
      uses: actions/download-artifact@v4
      with:
        path: all-builds
    
    - name: Consolidate Artifacts
      shell: pwsh
      run: |
        Write-Host "=== Consolidating All Builds ===" -ForegroundColor Cyan
        
        New-Item -ItemType Directory -Force -Path "consolidated/bin" | Out-Null
        New-Item -ItemType Directory -Force -Path "consolidated/lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "consolidated/include" | Out-Null
        
        # Copy all artifacts
        Get-ChildItem -Path "all-builds" -Recurse -File | ForEach-Object {
          $ext = $_.Extension
          if ($ext -eq ".dll" -or $ext -eq ".exe") {
            Copy-Item -Path $_.FullName -Destination "consolidated/bin/" -Force
            Write-Host "  Copied: $($_.Name) to bin/" -ForegroundColor Green
          } elseif ($ext -eq ".lib") {
            Copy-Item -Path $_.FullName -Destination "consolidated/lib/" -Force
            Write-Host "  Copied: $($_.Name) to lib/" -ForegroundColor Green
          } elseif ($ext -eq ".h" -or $ext -eq ".hpp") {
            Copy-Item -Path $_.FullName -Destination "consolidated/include/" -Force
          }
        }
        
        Write-Host "`n‚úì Consolidation complete" -ForegroundColor Green
    
    - name: Create Build Manifest
      shell: pwsh
      run: |
        Write-Host "=== Creating Build Manifest ===" -ForegroundColor Cyan
        
        $manifest = @{
          "build_date" = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          "components" = @{
            "cogutil" = "${{ needs.build-cogutil.result }}"
            "atomspace" = "${{ needs.build-atomspace.result }}"
            "moses" = "${{ needs.build-moses.result }}"
            "cogserver" = "${{ needs.build-cogserver.result }}"
          }
        }
        
        $manifest | ConvertTo-Json | Out-File "consolidated/build-manifest.json"
        
        Write-Host "`nBuild Manifest:" -ForegroundColor Yellow
        Get-Content "consolidated/build-manifest.json"
    
    - name: Upload Consolidated Build
      uses: actions/upload-artifact@v4
      with:
        name: occ-windows-complete
        path: |
          consolidated/**
        retention-days: 90
    
    - name: Build Summary
      shell: pwsh
      run: |
        Write-Host "`n=== OCC Windows Build Summary ===" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "Build Status:" -ForegroundColor Yellow
        Write-Host "  - CogUtil: ${{ needs.build-cogutil.result }}" -ForegroundColor $(if ("${{ needs.build-cogutil.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host "  - AtomSpace: ${{ needs.build-atomspace.result }}" -ForegroundColor $(if ("${{ needs.build-atomspace.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host "  - Moses: ${{ needs.build-moses.result }}" -ForegroundColor $(if ("${{ needs.build-moses.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host "  - CogServer: ${{ needs.build-cogserver.result }}" -ForegroundColor $(if ("${{ needs.build-cogserver.result }}" -eq "success") { "Green" } else { "Yellow" })
        Write-Host ""
        
        # Count successes
        $successCount = 0
        if ("${{ needs.build-cogutil.result }}" -eq "success") { $successCount++ }
        if ("${{ needs.build-atomspace.result }}" -eq "success") { $successCount++ }
        if ("${{ needs.build-moses.result }}" -eq "success") { $successCount++ }
        if ("${{ needs.build-cogserver.result }}" -eq "success") { $successCount++ }
        
        Write-Host "üìä Build Results: $successCount/4 components succeeded" -ForegroundColor Cyan
        Write-Host ""
        
        if ($successCount -eq 4) {
          Write-Host "‚úÖ All components built successfully!" -ForegroundColor Green
          Write-Host "   Ready for Electron app integration" -ForegroundColor Green
        } elseif ($successCount -ge 2) {
          Write-Host "‚ö†Ô∏è  Partial success - $successCount components built" -ForegroundColor Yellow
          Write-Host "   vcpkg dependencies cached for next iteration" -ForegroundColor Yellow
          Write-Host "   Check individual job logs for details" -ForegroundColor Yellow
        } else {
          Write-Host "‚ö†Ô∏è  Build in progress - vcpkg dependencies cached" -ForegroundColor Yellow
          Write-Host "   Next iteration will be faster (no 30-60 min dependency rebuild)" -ForegroundColor Yellow
        }
        
        Write-Host ""
        Write-Host "üíæ All artifacts retained for 90 days" -ForegroundColor Cyan
        
        # Always exit 0 to not fail the workflow
        exit 0
