name: OCC Windows Build

# Windows-specific build workflow for OpenCog Collection (OCC) monorepo
# Fixed version with proper vcpkg integration using GitHub Actions cache
# Builds components in dependency order: cogutil -> atomspace -> cogserver -> attention -> unify -> ure -> miner -> asmoses

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  CMAKE_GENERATOR: "Visual Studio 17 2022"
  # Use vcpkg's default Azure binary cache (pre-built packages) + GitHub Actions cache
  # IMPORTANT: Do NOT use "clear;" as it removes access to vcpkg's pre-built Azure binaries
  # This allows downloading pre-compiled Boost (~45min saved) on first run
  VCPKG_BINARY_SOURCES: "default,readwrite;x-gha,readwrite"

jobs:
  # Stage 0: Warm vcpkg binary cache
  # This job runs first and ONLY installs vcpkg dependencies.
  # It has a long timeout and minimal failure points, ensuring the GHA cache gets populated.
  # Once cached, subsequent runs will be fast (minutes instead of hours).
  vcpkg-cache-warmer:
    runs-on: windows-latest
    name: Warm vcpkg Cache
    timeout-minutes: 180  # 3 hours - enough for first-time Boost compilation

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '544a4c5c297e60e4ac4a5a1810df66748d908869'

    - name: Install ALL Dependencies (Cache Warming)
      shell: pwsh
      run: |
        Write-Host "=== Warming vcpkg Binary Cache ===" -ForegroundColor Cyan
        Write-Host "This installs ALL dependencies to populate the cache." -ForegroundColor Yellow
        Write-Host "First run may take 1-2 hours. Subsequent runs: ~5 minutes." -ForegroundColor Yellow
        Write-Host ""

        # Install cogutil dependencies
        Write-Host "Installing cogutil dependencies..." -ForegroundColor Cyan
        Set-Location cogutil
        & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet x64-windows
        Set-Location ..

        # Install atomspace dependencies
        Write-Host "Installing atomspace dependencies..." -ForegroundColor Cyan
        Set-Location atomspace
        & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet x64-windows
        Set-Location ..

        # Install moses dependencies
        Write-Host "Installing moses dependencies..." -ForegroundColor Cyan
        Set-Location moses
        & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet x64-windows
        Set-Location ..

        Write-Host ""
        Write-Host "=== Cache Warming Complete ===" -ForegroundColor Green
        Write-Host "Binary cache is now populated. Future builds will be fast!" -ForegroundColor Green

  # Stage 1: Build CogUtil (Foundation)
  build-cogutil:
    runs-on: windows-latest
    name: Build CogUtil (Windows)
    needs: vcpkg-cache-warmer  # Wait for cache to be warm

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    # Export GitHub Actions cache environment variables for vcpkg
    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '544a4c5c297e60e4ac4a5a1810df66748d908869'

    - name: Install Dependencies
      shell: pwsh
      run: |
        Write-Host "=== Installing Dependencies via vcpkg ===" -ForegroundColor Cyan

        # Install required dependencies for cogutil using component-specific vcpkg.json
        Set-Location cogutil
        & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet x64-windows
        Set-Location ..

        Write-Host "Dependencies installed successfully" -ForegroundColor Green

    - name: Configure CogUtil
      shell: pwsh
      run: |
        Write-Host "=== Configuring CogUtil ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path cogutil\build | Out-Null
        Set-Location cogutil\build
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\install"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build CogUtil
      shell: pwsh
      run: |
        Write-Host "=== Building CogUtil ===" -ForegroundColor Cyan
        Set-Location cogutil\build
        cmake --build . --config $env:BUILD_TYPE --parallel 2
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Build CogUtil Tests
      shell: pwsh
      run: |
        Write-Host "=== Building CogUtil Tests ===" -ForegroundColor Cyan
        Set-Location cogutil\build
        cmake --build . --config $env:BUILD_TYPE --target tests --parallel 2
        Write-Host "Test build complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Run CogUtil Tests
      shell: pwsh
      run: |
        Write-Host "=== Running CogUtil Tests ===" -ForegroundColor Cyan
        Set-Location cogutil\build
        ctest -C $env:BUILD_TYPE --output-on-failure
        Write-Host "Tests complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Print Test Log
      if: always()
      shell: pwsh
      run: |
        $logPath = "cogutil\build\tests\Testing\Temporary\LastTest.log"
        if (Test-Path $logPath) {
          Write-Host "=== Test Log ===" -ForegroundColor Yellow
          Get-Content $logPath
        } else {
          Write-Host "No test log found at $logPath" -ForegroundColor Yellow
        }
    
    - name: Install CogUtil
      shell: pwsh
      run: |
        Write-Host "=== Installing CogUtil ===" -ForegroundColor Cyan
        Set-Location cogutil\build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload CogUtil Build
      uses: actions/upload-artifact@v4
      with:
        name: cogutil-build-windows
        path: |
          install/**
        retention-days: 1

  # Stage 2: Build AtomSpace (depends on CogUtil)
  build-atomspace:
    runs-on: windows-latest
    name: Build AtomSpace (Windows)
    needs: build-cogutil
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Download CogUtil Build
      uses: actions/download-artifact@v4
      with:
        name: cogutil-build-windows
        path: install

    # Export GitHub Actions cache environment variables for vcpkg
    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '544a4c5c297e60e4ac4a5a1810df66748d908869'

    - name: Install Dependencies
      shell: pwsh
      run: |
        Write-Host "=== Installing Dependencies via vcpkg ===" -ForegroundColor Cyan

        # Install required dependencies for atomspace using component-specific vcpkg.json
        # Note: Not enabling rocksdb-storage or postgres-storage features for faster builds
        Set-Location atomspace
        & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet x64-windows
        Set-Location ..

        Write-Host "Dependencies installed successfully" -ForegroundColor Green

    - name: Configure AtomSpace
      shell: pwsh
      run: |
        Write-Host "=== Configuring AtomSpace ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path atomspace\build | Out-Null
        Set-Location atomspace\build
        
        # Add CogUtil to CMAKE_PREFIX_PATH
        $env:CMAKE_PREFIX_PATH = "$env:GITHUB_WORKSPACE\install"
        
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\install" `
          -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build AtomSpace
      shell: pwsh
      run: |
        Write-Host "=== Building AtomSpace ===" -ForegroundColor Cyan
        Set-Location atomspace\build
        cmake --build . --config $env:BUILD_TYPE --parallel 2
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Build AtomSpace Tests
      shell: pwsh
      run: |
        Write-Host "=== Building AtomSpace Tests ===" -ForegroundColor Cyan
        Set-Location atomspace\build
        cmake --build . --config $env:BUILD_TYPE --target tests --parallel 2
        Write-Host "Test build complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Run AtomSpace Tests
      shell: pwsh
      run: |
        Write-Host "=== Running AtomSpace Tests ===" -ForegroundColor Cyan
        Set-Location atomspace\build
        
        # Add CogUtil DLLs to PATH
        $env:PATH = "$env:GITHUB_WORKSPACE\install\bin;$env:PATH"
        
        ctest -C $env:BUILD_TYPE --output-on-failure
        Write-Host "Tests complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Print Test Log
      if: always()
      shell: pwsh
      run: |
        $logPath = "atomspace\build\tests\Testing\Temporary\LastTest.log"
        if (Test-Path $logPath) {
          Write-Host "=== Test Log ===" -ForegroundColor Yellow
          Get-Content $logPath
        } else {
          Write-Host "No test log found at $logPath" -ForegroundColor Yellow
        }
    
    - name: Install AtomSpace
      shell: pwsh
      run: |
        Write-Host "=== Installing AtomSpace ===" -ForegroundColor Cyan
        Set-Location atomspace\build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload AtomSpace Build
      uses: actions/upload-artifact@v4
      with:
        name: atomspace-build-windows
        path: |
          install/**
        retention-days: 1

  # Stage 3: Build Moses (depends on CogUtil)
  build-moses:
    runs-on: windows-latest
    name: Build Moses (Windows)
    needs: build-cogutil
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Download CogUtil Build
      uses: actions/download-artifact@v4
      with:
        name: cogutil-build-windows
        path: install

    # Export GitHub Actions cache environment variables for vcpkg
    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '544a4c5c297e60e4ac4a5a1810df66748d908869'

    - name: Install Dependencies
      shell: pwsh
      run: |
        Write-Host "=== Installing Dependencies via vcpkg ===" -ForegroundColor Cyan

        # Install required dependencies for moses using component-specific vcpkg.json
        Set-Location moses
        & "$env:VCPKG_ROOT\vcpkg.exe" install --triplet x64-windows
        Set-Location ..

        Write-Host "Dependencies installed successfully" -ForegroundColor Green

    - name: Configure Moses
      shell: pwsh
      run: |
        Write-Host "=== Configuring Moses ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path moses\build | Out-Null
        Set-Location moses\build
        
        # Add CogUtil to CMAKE_PREFIX_PATH
        $env:CMAKE_PREFIX_PATH = "$env:GITHUB_WORKSPACE\install"
        
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\install" `
          -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build Moses
      shell: pwsh
      run: |
        Write-Host "=== Building Moses ===" -ForegroundColor Cyan
        Set-Location moses\build
        cmake --build . --config $env:BUILD_TYPE --parallel 2
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Install Moses
      shell: pwsh
      run: |
        Write-Host "=== Installing Moses ===" -ForegroundColor Cyan
        Set-Location moses\build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload Moses Build
      uses: actions/upload-artifact@v4
      with:
        name: moses-build-windows
        path: |
          install/**
        retention-days: 1

  # Build Summary Job
  build-summary:
    runs-on: windows-latest
    name: Build Summary (Windows)
    needs: [vcpkg-cache-warmer, build-cogutil, build-atomspace, build-moses]
    if: always()

    steps:
    - name: Summary
      shell: pwsh
      run: |
        Write-Host "=== OCC Windows Build Summary ===" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "Build Status:" -ForegroundColor Yellow
        Write-Host "  - vcpkg Cache: ${{ needs.vcpkg-cache-warmer.result }}" -ForegroundColor $(if ("${{ needs.vcpkg-cache-warmer.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host "  - CogUtil: ${{ needs.build-cogutil.result }}" -ForegroundColor $(if ("${{ needs.build-cogutil.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host "  - AtomSpace: ${{ needs.build-atomspace.result }}" -ForegroundColor $(if ("${{ needs.build-atomspace.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host "  - Moses: ${{ needs.build-moses.result }}" -ForegroundColor $(if ("${{ needs.build-moses.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host ""

        if ("${{ needs.vcpkg-cache-warmer.result }}" -eq "success" -and "${{ needs.build-cogutil.result }}" -eq "success" -and "${{ needs.build-atomspace.result }}" -eq "success" -and "${{ needs.build-moses.result }}" -eq "success") {
          Write-Host "All builds completed successfully!" -ForegroundColor Green
          exit 0
        } else {
          Write-Host "Some builds failed. Check individual job logs for details." -ForegroundColor Red
          exit 1
        }
