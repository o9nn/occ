name: OCC Windows Build

# Windows-specific build workflow for OpenCog Collection (OCC) monorepo
# Fixed version with proper vcpkg integration using GitHub Actions cache
# Builds components in dependency order: cogutil -> atomspace -> cogserver -> attention -> unify -> ure -> miner -> asmoses

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release
  CMAKE_GENERATOR: "Visual Studio 17 2022"
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}\vcpkg_cache

jobs:
  # Stage 1: Build CogUtil (Foundation)
  build-cogutil:
    runs-on: windows-latest
    name: Build CogUtil (Windows)
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '544a4c5c297e60e4ac4a5a1810df66748d908869'
    
    - name: Create vcpkg cache directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
        Write-Host "vcpkg cache directory created at $env:VCPKG_DEFAULT_BINARY_CACHE" -ForegroundColor Green
    
    - name: Cache vcpkg binary packages
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-binary-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-binary-${{ runner.os }}-
    
    - name: Install Dependencies
      shell: pwsh
      run: |
        Write-Host "=== Installing Dependencies via vcpkg ===" -ForegroundColor Cyan
        
        # Install required dependencies for cogutil
        & "$env:VCPKG_ROOT\vcpkg.exe" install boost-system boost-filesystem boost-program-options boost-thread boost-date-time --triplet x64-windows
        
        Write-Host "Dependencies installed successfully" -ForegroundColor Green
    
    - name: Configure CogUtil
      shell: pwsh
      run: |
        Write-Host "=== Configuring CogUtil ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path cogutil\build | Out-Null
        Set-Location cogutil\build
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\install"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build CogUtil
      shell: pwsh
      run: |
        Write-Host "=== Building CogUtil ===" -ForegroundColor Cyan
        Set-Location cogutil\build
        cmake --build . --config $env:BUILD_TYPE --parallel 2
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Build CogUtil Tests
      shell: pwsh
      run: |
        Write-Host "=== Building CogUtil Tests ===" -ForegroundColor Cyan
        Set-Location cogutil\build
        cmake --build . --config $env:BUILD_TYPE --target tests --parallel 2
        Write-Host "Test build complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Run CogUtil Tests
      shell: pwsh
      run: |
        Write-Host "=== Running CogUtil Tests ===" -ForegroundColor Cyan
        Set-Location cogutil\build
        ctest -C $env:BUILD_TYPE --output-on-failure
        Write-Host "Tests complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Print Test Log
      if: always()
      shell: pwsh
      run: |
        $logPath = "cogutil\build\tests\Testing\Temporary\LastTest.log"
        if (Test-Path $logPath) {
          Write-Host "=== Test Log ===" -ForegroundColor Yellow
          Get-Content $logPath
        } else {
          Write-Host "No test log found at $logPath" -ForegroundColor Yellow
        }
    
    - name: Install CogUtil
      shell: pwsh
      run: |
        Write-Host "=== Installing CogUtil ===" -ForegroundColor Cyan
        Set-Location cogutil\build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload CogUtil Build
      uses: actions/upload-artifact@v4
      with:
        name: cogutil-build-windows
        path: |
          install/**
        retention-days: 1

  # Stage 2: Build AtomSpace (depends on CogUtil)
  build-atomspace:
    runs-on: windows-latest
    name: Build AtomSpace (Windows)
    needs: build-cogutil
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Download CogUtil Build
      uses: actions/download-artifact@v4
      with:
        name: cogutil-build-windows
        path: install
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '544a4c5c297e60e4ac4a5a1810df66748d908869'
    
    - name: Create vcpkg cache directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
        Write-Host "vcpkg cache directory created" -ForegroundColor Green
    
    - name: Cache vcpkg binary packages
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-binary-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-binary-${{ runner.os }}-
    
    - name: Install Dependencies
      shell: pwsh
      run: |
        Write-Host "=== Installing Dependencies via vcpkg ===" -ForegroundColor Cyan
        
        # Install required dependencies for atomspace
        & "$env:VCPKG_ROOT\vcpkg.exe" install boost-system boost-filesystem boost-program-options boost-thread boost-date-time --triplet x64-windows
        
        Write-Host "Dependencies installed successfully" -ForegroundColor Green
    
    - name: Configure AtomSpace
      shell: pwsh
      run: |
        Write-Host "=== Configuring AtomSpace ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path atomspace\build | Out-Null
        Set-Location atomspace\build
        
        # Add CogUtil to CMAKE_PREFIX_PATH
        $env:CMAKE_PREFIX_PATH = "$env:GITHUB_WORKSPACE\install"
        
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\install" `
          -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build AtomSpace
      shell: pwsh
      run: |
        Write-Host "=== Building AtomSpace ===" -ForegroundColor Cyan
        Set-Location atomspace\build
        cmake --build . --config $env:BUILD_TYPE --parallel 2
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Build AtomSpace Tests
      shell: pwsh
      run: |
        Write-Host "=== Building AtomSpace Tests ===" -ForegroundColor Cyan
        Set-Location atomspace\build
        cmake --build . --config $env:BUILD_TYPE --target tests --parallel 2
        Write-Host "Test build complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Run AtomSpace Tests
      shell: pwsh
      run: |
        Write-Host "=== Running AtomSpace Tests ===" -ForegroundColor Cyan
        Set-Location atomspace\build
        
        # Add CogUtil DLLs to PATH
        $env:PATH = "$env:GITHUB_WORKSPACE\install\bin;$env:PATH"
        
        ctest -C $env:BUILD_TYPE --output-on-failure
        Write-Host "Tests complete" -ForegroundColor Green
      continue-on-error: true
    
    - name: Print Test Log
      if: always()
      shell: pwsh
      run: |
        $logPath = "atomspace\build\tests\Testing\Temporary\LastTest.log"
        if (Test-Path $logPath) {
          Write-Host "=== Test Log ===" -ForegroundColor Yellow
          Get-Content $logPath
        } else {
          Write-Host "No test log found at $logPath" -ForegroundColor Yellow
        }
    
    - name: Install AtomSpace
      shell: pwsh
      run: |
        Write-Host "=== Installing AtomSpace ===" -ForegroundColor Cyan
        Set-Location atomspace\build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload AtomSpace Build
      uses: actions/upload-artifact@v4
      with:
        name: atomspace-build-windows
        path: |
          install/**
        retention-days: 1

  # Stage 3: Build Moses (depends on CogUtil)
  build-moses:
    runs-on: windows-latest
    name: Build Moses (Windows)
    needs: build-cogutil
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Download CogUtil Build
      uses: actions/download-artifact@v4
      with:
        name: cogutil-build-windows
        path: install
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '544a4c5c297e60e4ac4a5a1810df66748d908869'
    
    - name: Create vcpkg cache directory
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "$env:VCPKG_DEFAULT_BINARY_CACHE" | Out-Null
        Write-Host "vcpkg cache directory created" -ForegroundColor Green
    
    - name: Cache vcpkg binary packages
      uses: actions/cache@v4
      with:
        path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-binary-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-binary-${{ runner.os }}-
    
    - name: Install Dependencies
      shell: pwsh
      run: |
        Write-Host "=== Installing Dependencies via vcpkg ===" -ForegroundColor Cyan
        
        # Install required dependencies for moses
        & "$env:VCPKG_ROOT\vcpkg.exe" install boost-system boost-filesystem boost-program-options boost-thread boost-date-time --triplet x64-windows
        
        Write-Host "Dependencies installed successfully" -ForegroundColor Green
    
    - name: Configure Moses
      shell: pwsh
      run: |
        Write-Host "=== Configuring Moses ===" -ForegroundColor Cyan
        New-Item -ItemType Directory -Force -Path moses\build | Out-Null
        Set-Location moses\build
        
        # Add CogUtil to CMAKE_PREFIX_PATH
        $env:CMAKE_PREFIX_PATH = "$env:GITHUB_WORKSPACE\install"
        
        cmake .. `
          -G "$env:CMAKE_GENERATOR" `
          -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
          -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\install" `
          -DCMAKE_PREFIX_PATH="$env:CMAKE_PREFIX_PATH"
        Write-Host "Configuration complete" -ForegroundColor Green
    
    - name: Build Moses
      shell: pwsh
      run: |
        Write-Host "=== Building Moses ===" -ForegroundColor Cyan
        Set-Location moses\build
        cmake --build . --config $env:BUILD_TYPE --parallel 2
        Write-Host "Build complete" -ForegroundColor Green
    
    - name: Install Moses
      shell: pwsh
      run: |
        Write-Host "=== Installing Moses ===" -ForegroundColor Cyan
        Set-Location moses\build
        cmake --install . --config $env:BUILD_TYPE
        Write-Host "Installation complete" -ForegroundColor Green
    
    - name: Upload Moses Build
      uses: actions/upload-artifact@v4
      with:
        name: moses-build-windows
        path: |
          install/**
        retention-days: 1

  # Build Summary Job
  build-summary:
    runs-on: windows-latest
    name: Build Summary (Windows)
    needs: [build-cogutil, build-atomspace, build-moses]
    if: always()
    
    steps:
    - name: Summary
      shell: pwsh
      run: |
        Write-Host "=== OCC Windows Build Summary ===" -ForegroundColor Cyan
        Write-Host ""
        Write-Host "Build Status:" -ForegroundColor Yellow
        Write-Host "  - CogUtil: ${{ needs.build-cogutil.result }}" -ForegroundColor $(if ("${{ needs.build-cogutil.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host "  - AtomSpace: ${{ needs.build-atomspace.result }}" -ForegroundColor $(if ("${{ needs.build-atomspace.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host "  - Moses: ${{ needs.build-moses.result }}" -ForegroundColor $(if ("${{ needs.build-moses.result }}" -eq "success") { "Green" } else { "Red" })
        Write-Host ""
        
        if ("${{ needs.build-cogutil.result }}" -eq "success" -and "${{ needs.build-atomspace.result }}" -eq "success" -and "${{ needs.build-moses.result }}" -eq "success") {
          Write-Host "✅ All builds completed successfully!" -ForegroundColor Green
          exit 0
        } else {
          Write-Host "❌ Some builds failed. Check individual job logs for details." -ForegroundColor Red
          exit 1
        }
