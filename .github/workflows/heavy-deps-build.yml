name: Build Heavy Dependencies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'

jobs:
  build-protobuf:
    runs-on: windows-latest
    name: "Protobuf"
    steps:
      - uses: actions/checkout@v4

      - name: Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: prebuilt/protobuf
          key: protobuf-v28.3-win64

      - name: Build
        if: steps.cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          git clone --depth 1 --branch v28.3 --recurse-submodules https://github.com/protocolbuffers/protobuf.git vendor\protobuf
          rmdir /s /q vendor\protobuf\.git
          mkdir vendor\protobuf\build
          cd vendor\protobuf\build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=..\..\..\prebuilt\protobuf -Dprotobuf_BUILD_TESTS=OFF
          cmake --build . --config Release --parallel
          cmake --install . --config Release

      - uses: actions/upload-artifact@v4
        with:
          name: protobuf-win64
          path: prebuilt/protobuf
          retention-days: 0

  build-rocksdb:
    runs-on: windows-latest
    name: "RocksDB"
    steps:
      - uses: actions/checkout@v4

      - name: Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: prebuilt/rocksdb
          key: rocksdb-v9.8.4-win64

      - name: Build
        if: steps.cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          git clone --depth 1 --branch v9.8.4 https://github.com/facebook/rocksdb.git vendor\rocksdb
          rmdir /s /q vendor\rocksdb\.git
          mkdir vendor\rocksdb\build
          cd vendor\rocksdb\build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=..\..\..\prebuilt\rocksdb -DWITH_TESTS=OFF -DWITH_TOOLS=OFF -DROCKSDB_BUILD_SHARED=OFF
          cmake --build . --config Release --parallel
          cmake --install . --config Release

      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-win64
          path: prebuilt/rocksdb
          retention-days: 0

  build-grpc:
    runs-on: windows-latest
    name: "gRPC"
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: prebuilt/grpc
          key: grpc-v1.68.2-win64

      - name: Build
        if: steps.cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          git clone --depth 1 --branch v1.68.2 --recurse-submodules https://github.com/grpc/grpc.git vendor\grpc
          rmdir /s /q vendor\grpc\.git
          mkdir vendor\grpc\build
          cd vendor\grpc\build
          cmake .. -G "Visual Studio 17 2022" -A x64 -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=..\..\..\prebuilt\grpc -DgRPC_BUILD_TESTS=OFF -DgRPC_BUILD_CSHARP_EXT=OFF
          cmake --build . --config Release --parallel
          cmake --install . --config Release

      - uses: actions/upload-artifact@v4
        with:
          name: grpc-win64
          path: prebuilt/grpc
          retention-days: 0
